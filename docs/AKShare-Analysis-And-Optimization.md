# AKShare 接口分析与优化策略

## 📋 概述

本文档分析AKShare提供的所有主要接口，按数据更新频率进行分类，并设计优化的数据获取策略，以解决实时访问性能问题。

## 🔍 AKShare 接口完整分析

### 1. 股票基础数据接口

#### 1.1 股票列表和基本信息
```python
# 获取所有A股代码和名称
ak.stock_info_a_code_name()
# 返回: 股票代码、股票名称、上市日期、退市日期等

# 获取股票基本信息
ak.stock_individual_info_em(symbol="000001")
# 返回: 总股本、流通股本、市盈率、市净率、行业、概念等
```

**数据特征**:
- **更新频率**: 低频 (月度或季度更新)
- **数据稳定性**: 高 (基本信息变化缓慢)
- **获取成本**: 中等 (一次性获取大量数据)

#### 1.2 行业和概念分类
```python
# 行业分类
ak.stock_board_industry_name_em()
ak.stock_board_industry_cons_em(symbol="小金属")

# 概念分类
ak.stock_board_concept_name_em()
ak.stock_board_concept_cons_em(symbol="锂电池")
```

**数据特征**:
- **更新频率**: 低频 (季度更新)
- **数据稳定性**: 高
- **获取成本**: 低

---

### 2. 实时价格数据接口

#### 2.1 实时行情
```python
# 沪深A股实时行情
ak.stock_zh_a_spot_em()
# 返回: 代码、名称、最新价、涨跌幅、涨跌额、成交量、成交额、振幅、最高、最低、今开、昨收

# 个股实时行情
ak.stock_zh_a_hist(symbol="000001", period="daily", start_date="20231201", end_date="20231201", adjust="")
```

**数据特征**:
- **更新频率**: 极高频 (秒级更新)
- **数据稳定性**: 极低 (实时变化)
- **获取成本**: 高 (频繁访问，容易被限流)

#### 2.2 盘口数据
```python
# 实时分笔数据
ak.stock_zh_a_tick_tx_js(symbol="sh000001")

# 五档行情
ak.stock_bid_ask_em(symbol="000001")
```

**数据特征**:
- **更新频率**: 极高频 (毫秒级)
- **数据稳定性**: 极低
- **获取成本**: 极高

---

### 3. 历史数据接口

#### 3.1 K线数据
```python
# 日K线
ak.stock_zh_a_hist(symbol="000001", period="daily", start_date="20230101", end_date="20231201")

# 分钟K线
ak.stock_zh_a_hist_min_em(symbol="000001", period="1", start_date="20231201 09:30:00", end_date="20231201 15:00:00")
```

**数据特征**:
- **更新频率**:
  - 日K: 日度更新 (收盘后固化)
  - 分钟K: 高频更新 (分钟级)
- **数据稳定性**:
  - 历史数据: 高 (不会变化)
  - 当日数据: 低 (实时变化)
- **获取成本**: 中等

#### 3.2 成交明细
```python
# 历史成交明细
ak.stock_zh_a_tick_tx_js(symbol="sh000001", trade_date="20231201")
```

**数据特征**:
- **更新频率**: 高频 (交易时间内实时)
- **数据稳定性**: 中 (当日结束后固化)
- **获取成本**: 高

---

### 4. 财务数据接口

#### 4.1 财务报表
```python
# 资产负债表
ak.stock_balance_sheet_by_yearly_em(symbol="000001")

# 利润表
ak.stock_profit_sheet_by_yearly_em(symbol="000001")

# 现金流量表
ak.stock_cash_flow_sheet_by_yearly_em(symbol="000001")
```

**数据特征**:
- **更新频率**: 低频 (季报/年报)
- **数据稳定性**: 高 (正式披露后不变)
- **获取成本**: 低

#### 4.2 财务指标
```python
# 主要财务指标
ak.stock_financial_abstract_ths(symbol="000001", indicator="按报告期")

# 估值数据
ak.stock_a_pe_lg()  # 市盈率历史数据
```

**数据特征**:
- **更新频率**: 低频 (季度更新)
- **数据稳定性**: 高
- **获取成本**: 低

---

### 5. 资讯数据接口

#### 5.1 公司公告
```python
# 个股公告
ak.stock_notice_report(symbol="000001")

# 全市场公告
ak.stock_info_global_em(symbol="全部")
```

**数据特征**:
- **更新频率**: 中频 (不定期发布)
- **数据稳定性**: 高 (发布后不变)
- **获取成本**: 中等

#### 5.2 新闻资讯
```python
# 个股新闻
ak.stock_news_em(symbol="000001")

# 研报数据
ak.stock_research_report_em(symbol="000001")
```

**数据特征**:
- **更新频率**: 中频 (每日更新)
- **数据稳定性**: 高
- **获取成本**: 中等

---

### 6. 市场数据接口

#### 6.1 指数数据
```python
# 指数实时行情
ak.index_zh_a_spot_em()

# 指数历史数据
ak.index_zh_a_hist(symbol="000001", period="daily")
```

**数据特征**:
- **更新频率**: 实时数据高频，历史数据低频
- **数据稳定性**: 历史数据高，实时数据低
- **获取成本**: 中等

#### 6.2 市场统计
```python
# 龙虎榜数据
ak.stock_lhb_detail_em(start_date="20231201", end_date="20231201")

# 大宗交易
ak.stock_dzjy_mrmx(start_date="20231201", end_date="20231201")
```

**数据特征**:
- **更新频率**: 低频 (日度更新)
- **数据稳定性**: 高 (当日结束后固化)
- **获取成本**: 中等

---

## 📊 数据分类策略

### 🔴 极高频数据 (秒级/分钟级更新)
**特征**: 交易时间内实时变化，延迟敏感
**接口**:
- `stock_zh_a_spot_em()` - 实时行情
- `stock_bid_ask_em()` - 五档行情
- `stock_zh_a_tick_tx_js()` - 分笔数据
- 分钟K线当前数据

**处理策略**:
- ✅ **实时获取**: 必须通过AKShare实时获取
- ✅ **Redis缓存**: 30秒-2分钟缓存
- ✅ **限流控制**: 严格控制调用频率
- ❌ **不适合**: 预先批量获取

### 🟡 高频数据 (分钟级/小时级更新)
**特征**: 交易时间内频繁变化，有一定延迟容忍度
**接口**:
- 分钟K线历史数据
- 成交明细数据
- 实时新闻推送

**处理策略**:
- ✅ **混合模式**: 实时+缓存结合
- ✅ **Redis缓存**: 5-15分钟缓存
- ✅ **增量更新**: 只获取最新数据
- ⚠️ **部分预取**: 历史数据可预取

### 🟢 中频数据 (日级更新)
**特征**: 每日更新一次，通常在收盘后确定
**接口**:
- 日K线数据
- 龙虎榜数据
- 大宗交易数据
- 每日新闻汇总

**处理策略**:
- ✅ **夜间批处理**: 每日凌晨批量更新
- ✅ **PostgreSQL存储**: 持久化存储
- ✅ **增量同步**: 只更新最新日期
- ✅ **Redis缓存**: 1-4小时缓存

### 🔵 低频数据 (周级/月级/季度更新)
**特征**: 更新频率低，数据相对稳定
**接口**:
- 股票基本信息
- 财务报表数据
- 行业分类数据
- 公司公告

**处理策略**:
- ✅ **周期批处理**: 周末或月初批量更新
- ✅ **PostgreSQL存储**: 作为主数据源
- ✅ **长期缓存**: 24小时-7天缓存
- ✅ **完全预取**: 提前获取所有数据

### ⚪ 静态数据 (极少变化)
**特征**: 几乎不变化的基础数据
**接口**:
- 股票代码列表
- 交易所信息
- 节假日数据

**处理策略**:
- ✅ **一次性获取**: 系统初始化时获取
- ✅ **PostgreSQL存储**: 永久存储
- ✅ **内存缓存**: 应用启动时加载
- ✅ **手动更新**: 仅在必要时手动刷新

---

## 🏗️ 优化架构设计

### 数据获取层架构
```
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│   实时数据层        │    │   批处理数据层      │    │   静态数据层        │
│                     │    │                     │    │                     │
│ • 实时行情          │    │ • 日K线数据         │    │ • 股票代码列表      │
│ • 五档行情          │    │ • 财务数据          │    │ • 基本信息          │
│ • 分笔数据          │    │ • 公告新闻          │    │ • 行业分类          │
│                     │    │ • 龙虎榜数据        │    │                     │
│ Redis缓存(30s-2min) │    │ PostgreSQL存储      │    │ 内存缓存(永久)      │
└─────────────────────┘    └─────────────────────┘    └─────────────────────┘
           │                          │                          │
           └──────────────────────────┼──────────────────────────┘
                                      │
                               ┌─────────────────────┐
                               │   统一数据服务层    │
                               │                     │
                               │ • 智能路由          │
                               │ • 缓存策略          │
                               │ • 降级机制          │
                               │ • 限流控制          │
                               └─────────────────────┘
```

### 数据更新时间表
```
时间段          │ 更新内容                    │ 数据源策略
──────────────────────────────────────────────────────────
09:15-15:00    │ 实时行情、分笔数据          │ AKShare实时 + Redis缓存
15:30-16:00    │ 当日K线数据固化             │ 批量获取并存储
18:00-20:00    │ 龙虎榜、大宗交易数据        │ 批量获取并存储
21:00-23:00    │ 公告、新闻数据              │ 批量获取并存储
01:00-05:00    │ 财务数据、基本信息更新      │ 周期性批量更新
周末           │ 行业分类、概念板块更新      │ 周期性全量更新
```

---

## 🚀 实施计划

### Phase 1: 数据分层存储 (1-2天)
1. **设计PostgreSQL表结构**
   - 股票基本信息表
   - 日K线数据表
   - 财务数据表
   - 公告新闻表

2. **实现批处理服务**
   - 定时任务调度器
   - 数据获取和清洗逻辑
   - 增量更新机制

### Phase 2: 智能缓存系统 (1天)
1. **优化Redis缓存策略**
   - 分级缓存TTL设置
   - 缓存预热机制
   - 缓存失效处理

2. **实现数据路由层**
   - 智能数据源选择
   - 降级机制
   - 监控和告警

### Phase 3: 性能优化 (1天)
1. **AKShare调用优化**
   - 连接池管理
   - 请求限流控制
   - 错误重试机制

2. **系统监控完善**
   - 数据获取成功率监控
   - 响应时间监控
   - 数据新鲜度监控

---

## 📈 预期效果

### 性能提升
- **响应时间**: 从2-5分钟降低到100ms以内
- **系统可用性**: 从60%提升到99%+
- **AKShare调用频率**: 减少90%的实时调用

### 用户体验
- **实时数据**: 30秒内的准实时体验
- **历史数据**: 毫秒级响应
- **系统稳定性**: 不再依赖AKShare实时可用性

### 系统架构
- **可扩展性**: 支持更多数据源接入
- **可维护性**: 清晰的数据分层架构
- **可监控性**: 全链路数据质量监控

---

**文档创建时间**: 2025-09-19
**负责人**: Claude Code AI
**状态**: 设计完成，待实施