# 03-现成产品部署

> **尽量使用现成产品 - 避免自己开发陷入依赖地狱**
>
> 所有组件优先使用成熟的Docker镜像和开源产品

## 🐳 Docker Compose 完整配置

### docker-compose.yml (生产就绪)
```yaml
version: '3.8'

services:
  # ===== 基础设施层 =====

  postgres:
    image: timescale/timescaledb:latest-pg15
    container_name: prism2-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: prism2
      POSTGRES_USER: prism2
      POSTGRES_PASSWORD: prism2_secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: unless-stopped
    healthcheck:
      test: pg_isready -U prism2 -d prism2
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: prism2-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    healthcheck:
      test: redis-cli ping
      interval: 10s
      timeout: 3s
      retries: 5

  nginx:
    image: nginx:alpine
    container_name: prism2-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - backend
    restart: unless-stopped
    healthcheck:
      test: curl -f http://localhost/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # ===== AI模型层 =====

  ollama:
    image: ollama/ollama:latest
    container_name: prism2-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # ===== 应用服务层 =====

  backend:
    image: python:3.12-slim
    container_name: prism2-backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    working_dir: /app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    environment:
      - DATABASE_URL=postgresql://prism2:prism2_secure_password@postgres:5432/prism2
      - REDIS_URL=redis://redis:6379
      - OLLAMA_URL=http://ollama:11434
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  rag-service:
    image: python:3.12-slim
    container_name: prism2-rag
    ports:
      - "8001:8001"
    volumes:
      - ./rag-service:/app
      - rag_vectors:/app/vectors
      - chromadb_data:/app/chromadb
    working_dir: /app
    command: uvicorn main:app --host 0.0.0.0 --port 8001
    environment:
      - DATABASE_URL=postgresql://prism2:prism2_secure_password@postgres:5432/prism2
      - REDIS_URL=redis://redis:6379/2
      - CHROMADB_HOST=chromadb
      - CHROMADB_PORT=8000
      - EMBEDDING_MODEL=sentence-transformers/bge-large-zh-v1.5
      - VECTOR_STORE_PATH=/app/vectors
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      chromadb:
        condition: service_healthy
    restart: unless-stopped

  # ChromaDB 向量数据库 (RAG核心组件)
  chromadb:
    image: chromadb/chroma:latest
    container_name: prism2-chromadb
    ports:
      - "8000:8000"
    volumes:
      - chromadb_data:/chroma/chroma
    environment:
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
      - PERSIST_DIRECTORY=/chroma/chroma
      # 明确清除代理设置，防止企业代理干扰
      - http_proxy=
      - https_proxy=
      - HTTP_PROXY=
      - HTTPS_PROXY=
      - no_proxy=localhost,127.0.0.1,::1
      - NO_PROXY=localhost,127.0.0.1,::1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  push-service:
    image: python:3.12-slim
    container_name: prism2-push
    ports:
      - "8002:8002"
    volumes:
      - ./push-service:/app
    working_dir: /app
    command: uvicorn main:app --host 0.0.0.0 --port 8002
    environment:
      - REDIS_URL=redis://redis:6379/1
      - BACKEND_URL=http://backend:8000
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  frontend:
    image: node:18-alpine
    container_name: prism2-frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
    working_dir: /app
    command: npm run dev
    environment:
      - REACT_APP_API_URL=http://localhost/api/v1
      - REACT_APP_WS_URL=ws://localhost/ws
    restart: unless-stopped

  # ===== 批处理任务 =====

  batch-crawler:
    image: python:3.12-slim
    container_name: prism2-batch
    volumes:
      - ./batch-service:/app
    working_dir: /app
    command: python scheduler.py
    environment:
      - DATABASE_URL=postgresql://prism2:prism2_secure_password@postgres:5432/prism2
      - REDIS_URL=redis://redis:6379/3
      - RAG_SERVICE_URL=http://rag-service:8001
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    # 夜间批处理，仅在2:00-6:00运行
    deploy:
      replicas: 1

volumes:
  postgres_data:
  redis_data:
  ollama_data:
  rag_vectors:
  chromadb_data:

networks:
  default:
    name: prism2-network
```

## 🚀 快速启动脚本

### start.sh (一键启动)
```bash
#!/bin/bash
set -e

echo "🚀 启动Prism2股票分析平台..."

# 创建必要目录
mkdir -p nginx/ssl
mkdir -p data/{postgres,redis,vectors}

# 检查Docker和Docker Compose
command -v docker >/dev/null 2>&1 || { echo "请先安装Docker"; exit 1; }
command -v docker-compose >/dev/null 2>&1 || { echo "请先安装Docker Compose"; exit 1; }

# 拉取最新镜像
echo "📦 拉取最新镜像..."
docker-compose pull

# 启动基础设施
echo "🔧 启动基础设施..."
docker-compose up -d postgres redis

# 等待基础设施就绪
echo "⏳ 等待数据库就绪..."
sleep 10

# 初始化数据库
echo "📊 初始化数据库..."
docker-compose exec postgres psql -U prism2 -d prism2 -c "SELECT version();"

# 启动应用服务
echo "🎯 启动应用服务..."
docker-compose up -d ollama backend rag-service push-service

# 启动前端和反向代理
echo "🌐 启动前端服务..."
docker-compose up -d frontend nginx

# 启动批处理任务
echo "🔄 启动批处理任务..."
docker-compose up -d batch-crawler

# 健康检查
echo "✅ 系统健康检查..."
sleep 5

services=("postgres:5432" "redis:6379" "backend:8000" "rag-service:8001" "frontend:3000")
for service in "${services[@]}"; do
    IFS=':' read -r name port <<< "$service"
    if nc -z localhost "$port"; then
        echo "✅ $name (端口$port): 运行正常"
    else
        echo "❌ $name (端口$port): 连接失败"
    fi
done

echo ""
echo "🎉 Prism2平台启动完成！"
echo "🌐 访问地址:"
echo "   主页面: http://localhost"
echo "   API文档: http://localhost/docs"
echo "   Ollama: http://localhost:11434"
echo ""
echo "📊 监控命令:"
echo "   查看日志: docker-compose logs -f [service]"
echo "   系统状态: docker-compose ps"
echo "   停止服务: docker-compose down"
```

### stop.sh (一键停止)
```bash
#!/bin/bash

echo "🛑 停止Prism2平台..."

# 优雅停止应用服务
docker-compose stop frontend nginx push-service backend rag-service batch-crawler

# 停止AI模型 (需要时间保存状态)
echo "🤖 停止AI模型..."
docker-compose stop ollama

# 停止基础设施
echo "💾 停止基础设施..."
docker-compose stop redis postgres

echo "✅ 所有服务已停止"
echo "💡 如需完全清理: docker-compose down -v"
```

## 📦 现成产品详细说明

### 🐘 数据库层: TimescaleDB
- **产品**: TimescaleDB (PostgreSQL扩展)
- **镜像**: `timescale/timescaledb:latest-pg15`
- **用途**: 主数据库 + 时序数据优化
- **优势**: PostgreSQL兼容 + 时序数据专门优化
- **成熟度**: ⭐⭐⭐⭐⭐ (生产级企业方案)
- **许可证**: Apache 2.0 (免费商用)

### 🔴 缓存层: Redis 7
- **产品**: Redis
- **镜像**: `redis:7-alpine`
- **用途**: 高速缓存 + 会话存储 + 消息队列
- **优势**: 内存数据库、持久化、分布式
- **成熟度**: ⭐⭐⭐⭐⭐ (行业标准)
- **许可证**: BSD (完全免费)

### 🤖 AI模型层: Ollama + 语言模型
- **产品**: Ollama (LLM管理平台)
- **镜像**: `ollama/ollama:latest`
- **用途**: 本地大语言模型服务
- **支持模型**:
  - Qwen2.5-7B-Instruct (中文优化)
  - Deepseek-Coder (代码能力)
  - Llama3.1 (通用能力)
- **优势**: 离线部署、模型切换、标准API
- **成熟度**: ⭐⭐⭐⭐ (快速发展)
- **许可证**: MIT (开源免费)

### 🔗 向量数据库: ChromaDB
- **产品**: ChromaDB
- **镜像**: `chromadb/chroma:latest`
- **用途**: RAG向量存储和语义搜索
- **优势**:
  - 专门为AI应用设计
  - 自动向量化
  - 高效相似度搜索
  - RESTful API
- **成熟度**: ⭐⭐⭐⭐ (AI领域标准)
- **许可证**: Apache 2.0 (免费商用)

### 🧠 向量模型: BGE-Large-zh-v1.5
- **产品**: Beijing Academy of AI (智源)开源模型
- **模型**: `sentence-transformers/bge-large-zh-v1.5`
- **用途**: 中文文本向量化
- **优势**:
  - 中文语义理解优秀
  - 支持长文本(512 tokens)
  - 金融领域表现良好
- **成熟度**: ⭐⭐⭐⭐⭐ (中文最佳)
- **许可证**: MIT (免费使用)

### 🌐 反向代理: Nginx
- **产品**: Nginx
- **镜像**: `nginx:alpine`
- **用途**: 负载均衡 + SSL终止 + 静态文件
- **优势**: 高并发、低内存、稳定可靠
- **配置**: HTTP代理 + WebSocket支持
- **成熟度**: ⭐⭐⭐⭐⭐ (Web服务器之王)
- **许可证**: BSD (免费商用)

### 🐍 应用运行时: Python 3.12
- **产品**: Python官方运行时
- **镜像**: `python:3.12-slim`
- **用途**: 后端服务运行环境
- **优势**:
  - 最新语言特性
  - 丰富的金融分析库
  - 类型提示完善
  - 性能优化
- **核心依赖库**:
  - FastAPI (Web框架)
  - SQLAlchemy (ORM)
  - AKShare (金融数据)
  - LangChain (RAG框架)
  - Sentence-Transformers (向量化)

### ⚡ 前端运行时: Node.js 18
- **产品**: Node.js官方运行时
- **镜像**: `node:18-alpine`
- **用途**: React前端构建和运行
- **优势**:
  - LTS长期支持版本
  - NPM生态丰富
  - 构建工具成熟
- **核心依赖库**:
  - React 18 (UI框架)
  - TypeScript (类型安全)
  - Vite (构建工具)
  - TailwindCSS (样式框架)
  - ECharts (图表库)

## 🔄 数据处理产品栈

### 📊 股票数据源: AKShare
- **产品**: AKShare开源金融数据接口
- **版本**: 1.12.0+
- **用途**: 股票价格、财报、公告数据获取
- **优势**:
  - 完全免费
  - 数据源丰富(东财、新浪、雪球等)
  - 中文股市专门优化
  - 社区活跃维护
- **许可证**: MIT (开源免费)

### 📰 新闻数据源: RSS
- **产品**: 新浪财经RSS源
- **地址**: `http://rss.sina.com.cn/roll/finance/hot_roll.xml`
- **用途**: 财经新闻实时获取
- **状态**: ✅ 已验证可用 (其他RSS源已失效)
- **优势**: 免费、实时、结构化

### 🔧 后台处理: APScheduler
- **产品**: Advanced Python Scheduler
- **用途**: 夜间批处理任务调度
- **优势**: Cron表达式、持久化任务、集群支持
- **许可证**: MIT (开源免费)

## 💰 成本分析 (完全免费方案)

| 组件 | 产品 | 许可证 | 费用 |
|------|------|--------|------|
| 数据库 | TimescaleDB | Apache 2.0 | 免费 |
| 缓存 | Redis | BSD | 免费 |
| 向量数据库 | ChromaDB | Apache 2.0 | 免费 |
| AI模型 | Ollama+Qwen | MIT | 免费 |
| 向量模型 | BGE-zh-v1.5 | MIT | 免费 |
| Web服务器 | Nginx | BSD | 免费 |
| 应用运行时 | Python/Node | PSF/MIT | 免费 |
| 数据源 | AKShare+RSS | MIT/公开 | 免费 |
| **总计** | **完整方案** | **开源** | **¥0** |

## 🎯 现成产品优势总结

1. **零开发成本**: 所有组件都是成熟产品，无需自研
2. **生产就绪**: 所有组件都有大规模生产使用案例
3. **社区支持**: 活跃的开源社区提供技术支持
4. **文档完善**: 详细的官方文档和最佳实践
5. **无供应商锁定**: 开源方案，随时可以迁移
6. **持续更新**: 产品持续维护和功能增强

## 🔧 生产环境优化

### 资源限制配置
```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  postgres:
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
```

### 日志管理
```yaml
services:
  backend:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

### 自动重启策略
```yaml
services:
  backend:
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
```

## ⚠️ 部署注意事项

1. **GPU支持**: Ollama需要NVIDIA GPU，无GPU环境请使用CPU版本
2. **内存要求**: 建议16GB+内存，AI模型至少需要8GB
3. **磁盘空间**: 预留50GB+空间存储模型和数据
4. **网络端口**: 确保防火墙开放80、443、5432、6379端口
5. **SSL证书**: 生产环境请配置有效的SSL证书

---

**📅 创建时间**: 2025-09-18
**🐳 Docker版本**: 24.0+
**✅ 测试状态**: 开发环境验证完成