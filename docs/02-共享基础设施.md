# 02-共享基础设施

> **使用共通基座 - Redis、Nginx、PostgreSQL**
>
> 所有模块共享基础设施，严禁每个模块安装自己的实例

## 🐘 PostgreSQL (共享数据库)

### 连接配置（统一固定）
```bash
主机: localhost
端口: 5432
数据库: prism2
用户: prism2
密码: prism2_secure_password
连接字符串: postgresql://prism2:prism2_secure_password@localhost:5432/prism2
```

### 数据库分配策略
```sql
-- 所有业务表共享一个数据库
-- 通过表前缀区分模块
stocks_*           # 股票相关表
news_*             # 新闻相关表
rag_*              # RAG相关表
ai_*               # AI分析相关表
system_*           # 系统配置表
```

### 连接池配置
```python
# SQLAlchemy配置（所有模块统一）
pool_size = 20
max_overflow = 30
pool_timeout = 30
pool_recycle = 3600
```

## 🔴 Redis (共享缓存)

### 连接配置（统一固定）
```bash
主机: localhost
端口: 6379
密码: 无
最大连接数: 100
连接池大小: 20
```

### 数据库分配策略
```bash
Database 0: 股票业务缓存
  - stock:*
  - kline:*
  - financial:*

Database 1: 搜索和临时缓存
  - search:*
  - temp:*

Database 2: 系统级缓存
  - rate:*
  - health:*
  - session:*

Database 3-15: 预留扩展
```

### TTL策略（严格执行）
```python
CACHE_TTL = {
    'stock_info': 86400,      # 基础信息 1天
    'realtime': 0,            # 实时数据不缓存
    'kline': 1800,            # K线数据 30分钟
    'news': 14400,            # 新闻 4小时
    'ai_analysis': 86400,     # AI分析 1天
    'search': 300,            # 搜索 5分钟
    'rate_limit': 60,         # 限流 1分钟
}
```

## 🌐 Nginx (共享反向代理)

### 端口路由配置
```nginx
upstream frontend {
    server localhost:3000;
}

upstream backend {
    server localhost:8000;
}

upstream rag_service {
    server localhost:8001;
}

upstream push_service {
    server localhost:8002;
}

server {
    listen 80;
    server_name prism2.local;

    # 前端静态资源
    location / {
        proxy_pass http://frontend;
    }

    # API路由
    location /api/v1/ {
        proxy_pass http://backend;
    }

    # RAG服务
    location /api/rag/ {
        proxy_pass http://rag_service;
    }

    # 推送服务
    location /api/push/ {
        proxy_pass http://push_service;
    }

    # WebSocket支持
    location /ws/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

## 🐳 Docker基础镜像 (现成产品)

### PostgreSQL容器
```yaml
services:
  postgres:
    image: timescale/timescaledb:latest-pg15
    container_name: prism2-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: prism2
      POSTGRES_USER: prism2
      POSTGRES_PASSWORD: prism2_secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
```

### Redis容器
```yaml
  redis:
    image: redis:7-alpine
    container_name: prism2-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes
```

### Nginx容器
```yaml
  nginx:
    image: nginx:alpine
    container_name: prism2-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend
    restart: unless-stopped
```

## 📊 监控和健康检查

### 健康检查端点
```bash
# PostgreSQL
pg_isready -h localhost -p 5432 -U prism2

# Redis
redis-cli -h localhost -p 6379 ping

# Nginx
curl -f http://localhost/health || exit 1
```

### 性能监控
```python
# 连接池监控
def check_db_pool():
    engine.pool.status()  # 返回连接池状态

def check_redis_pool():
    redis_pool.connection_pool.connection_kwargs
```

## 🔧 环境变量配置

### 共享配置文件 (.env)
```bash
# 数据库配置
DATABASE_URL=postgresql://prism2:prism2_secure_password@localhost:5432/prism2

# Redis配置
REDIS_URL=redis://localhost:6379

# 代理配置
HTTP_PROXY=
HTTPS_PROXY=
NO_PROXY=localhost,127.0.0.1,::1

# 共享密钥
JWT_SECRET=your_jwt_secret_here
ENCRYPTION_KEY=your_encryption_key_here
```

## ⚡ 性能优化配置

### PostgreSQL优化
```sql
-- 连接数配置
max_connections = 200
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 4MB
maintenance_work_mem = 64MB

-- TimescaleDB时序优化
shared_preload_libraries = 'timescaledb'
```

### Redis优化
```bash
# 内存配置
maxmemory 2gb
maxmemory-policy allkeys-lru

# 持久化配置
save 900 1
save 300 10
save 60 10000
```

## 🚫 严禁事项

1. **严禁独立数据库** - 任何模块不得创建独立的PostgreSQL/MySQL实例
2. **严禁独立缓存** - 任何模块不得创建独立的Redis/Memcached实例
3. **严禁绕过Nginx** - 所有HTTP流量必须经过Nginx代理
4. **严禁修改端口** - 基础设施端口严格按照规范，不得随意更改
5. **严禁直连数据库** - 应用必须通过连接池访问数据库

---

**📅 创建时间**: 2025-09-18
**🔒 配置状态**: 生产就绪
**⚠️ 重要提醒**: 修改基础设施配置前必须通知所有相关模块