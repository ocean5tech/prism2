# 02-å…±äº«åŸºç¡€è®¾æ–½

> **ä½¿ç”¨å…±é€šåŸºåº§ - Redisã€Nginxã€PostgreSQL**
>
> æ‰€æœ‰æ¨¡å—å…±äº«åŸºç¡€è®¾æ–½ï¼Œä¸¥ç¦æ¯ä¸ªæ¨¡å—å®‰è£…è‡ªå·±çš„å®ä¾‹

## ğŸ˜ PostgreSQL (å…±äº«æ•°æ®åº“)

### è¿æ¥é…ç½®ï¼ˆç»Ÿä¸€å›ºå®šï¼‰
```bash
ä¸»æœº: localhost
ç«¯å£: 5432
æ•°æ®åº“: prism2
ç”¨æˆ·: prism2
å¯†ç : prism2_secure_password
è¿æ¥å­—ç¬¦ä¸²: postgresql://prism2:prism2_secure_password@localhost:5432/prism2
```

### æ•°æ®åº“åˆ†é…ç­–ç•¥
```sql
-- æ‰€æœ‰ä¸šåŠ¡è¡¨å…±äº«ä¸€ä¸ªæ•°æ®åº“
-- é€šè¿‡è¡¨å‰ç¼€åŒºåˆ†æ¨¡å—
stocks_*           # è‚¡ç¥¨ç›¸å…³è¡¨
news_*             # æ–°é—»ç›¸å…³è¡¨
rag_*              # RAGç›¸å…³è¡¨
ai_*               # AIåˆ†æç›¸å…³è¡¨
system_*           # ç³»ç»Ÿé…ç½®è¡¨
```

### è¿æ¥æ± é…ç½®
```python
# SQLAlchemyé…ç½®ï¼ˆæ‰€æœ‰æ¨¡å—ç»Ÿä¸€ï¼‰
pool_size = 20
max_overflow = 30
pool_timeout = 30
pool_recycle = 3600
```

## ğŸ”´ Redis (å…±äº«ç¼“å­˜)

### è¿æ¥é…ç½®ï¼ˆç»Ÿä¸€å›ºå®šï¼‰
```bash
ä¸»æœº: localhost
ç«¯å£: 6379
å¯†ç : æ— 
æœ€å¤§è¿æ¥æ•°: 100
è¿æ¥æ± å¤§å°: 20
```

### æ•°æ®åº“åˆ†é…ç­–ç•¥
```bash
Database 0: è‚¡ç¥¨ä¸šåŠ¡ç¼“å­˜
  - stock:*
  - kline:*
  - financial:*

Database 1: æœç´¢å’Œä¸´æ—¶ç¼“å­˜
  - search:*
  - temp:*

Database 2: ç³»ç»Ÿçº§ç¼“å­˜
  - rate:*
  - health:*
  - session:*

Database 3-15: é¢„ç•™æ‰©å±•
```

### TTLç­–ç•¥ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰
```python
CACHE_TTL = {
    'stock_info': 86400,      # åŸºç¡€ä¿¡æ¯ 1å¤©
    'realtime': 0,            # å®æ—¶æ•°æ®ä¸ç¼“å­˜
    'kline': 1800,            # Kçº¿æ•°æ® 30åˆ†é’Ÿ
    'news': 14400,            # æ–°é—» 4å°æ—¶
    'ai_analysis': 86400,     # AIåˆ†æ 1å¤©
    'search': 300,            # æœç´¢ 5åˆ†é’Ÿ
    'rate_limit': 60,         # é™æµ 1åˆ†é’Ÿ
}
```

## ğŸŒ Nginx (å…±äº«åå‘ä»£ç†)

### ç«¯å£è·¯ç”±é…ç½®
```nginx
upstream frontend {
    server localhost:3000;
}

upstream backend {
    server localhost:8000;
}

upstream rag_service {
    server localhost:8001;
}

upstream push_service {
    server localhost:8002;
}

server {
    listen 80;
    server_name prism2.local;

    # å‰ç«¯é™æ€èµ„æº
    location / {
        proxy_pass http://frontend;
    }

    # APIè·¯ç”±
    location /api/v1/ {
        proxy_pass http://backend;
    }

    # RAGæœåŠ¡
    location /api/rag/ {
        proxy_pass http://rag_service;
    }

    # æ¨é€æœåŠ¡
    location /api/push/ {
        proxy_pass http://push_service;
    }

    # WebSocketæ”¯æŒ
    location /ws/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

## ğŸ³ DockeråŸºç¡€é•œåƒ (ç°æˆäº§å“)

### PostgreSQLå®¹å™¨
```yaml
services:
  postgres:
    image: timescale/timescaledb:latest-pg15
    container_name: prism2-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: prism2
      POSTGRES_USER: prism2
      POSTGRES_PASSWORD: prism2_secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
```

### Rediså®¹å™¨
```yaml
  redis:
    image: redis:7-alpine
    container_name: prism2-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes
```

### Nginxå®¹å™¨
```yaml
  nginx:
    image: nginx:alpine
    container_name: prism2-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend
    restart: unless-stopped
```

## ğŸ“Š ç›‘æ§å’Œå¥åº·æ£€æŸ¥

### å¥åº·æ£€æŸ¥ç«¯ç‚¹
```bash
# PostgreSQL
pg_isready -h localhost -p 5432 -U prism2

# Redis
redis-cli -h localhost -p 6379 ping

# Nginx
curl -f http://localhost/health || exit 1
```

### æ€§èƒ½ç›‘æ§
```python
# è¿æ¥æ± ç›‘æ§
def check_db_pool():
    engine.pool.status()  # è¿”å›è¿æ¥æ± çŠ¶æ€

def check_redis_pool():
    redis_pool.connection_pool.connection_kwargs
```

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

### å…±äº«é…ç½®æ–‡ä»¶ (.env)
```bash
# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://prism2:prism2_secure_password@localhost:5432/prism2

# Redisé…ç½®
REDIS_URL=redis://localhost:6379

# ä»£ç†é…ç½®
HTTP_PROXY=
HTTPS_PROXY=
NO_PROXY=localhost,127.0.0.1,::1

# å…±äº«å¯†é’¥
JWT_SECRET=your_jwt_secret_here
ENCRYPTION_KEY=your_encryption_key_here
```

## âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®

### PostgreSQLä¼˜åŒ–
```sql
-- è¿æ¥æ•°é…ç½®
max_connections = 200
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 4MB
maintenance_work_mem = 64MB

-- TimescaleDBæ—¶åºä¼˜åŒ–
shared_preload_libraries = 'timescaledb'
```

### Redisä¼˜åŒ–
```bash
# å†…å­˜é…ç½®
maxmemory 2gb
maxmemory-policy allkeys-lru

# æŒä¹…åŒ–é…ç½®
save 900 1
save 300 10
save 60 10000
```

## ğŸš« ä¸¥ç¦äº‹é¡¹

1. **ä¸¥ç¦ç‹¬ç«‹æ•°æ®åº“** - ä»»ä½•æ¨¡å—ä¸å¾—åˆ›å»ºç‹¬ç«‹çš„PostgreSQL/MySQLå®ä¾‹
2. **ä¸¥ç¦ç‹¬ç«‹ç¼“å­˜** - ä»»ä½•æ¨¡å—ä¸å¾—åˆ›å»ºç‹¬ç«‹çš„Redis/Memcachedå®ä¾‹
3. **ä¸¥ç¦ç»•è¿‡Nginx** - æ‰€æœ‰HTTPæµé‡å¿…é¡»ç»è¿‡Nginxä»£ç†
4. **ä¸¥ç¦ä¿®æ”¹ç«¯å£** - åŸºç¡€è®¾æ–½ç«¯å£ä¸¥æ ¼æŒ‰ç…§è§„èŒƒï¼Œä¸å¾—éšæ„æ›´æ”¹
5. **ä¸¥ç¦ç›´è¿æ•°æ®åº“** - åº”ç”¨å¿…é¡»é€šè¿‡è¿æ¥æ± è®¿é—®æ•°æ®åº“

---

**ğŸ“… åˆ›å»ºæ—¶é—´**: 2025-09-18
**ğŸ”’ é…ç½®çŠ¶æ€**: ç”Ÿäº§å°±ç»ª
**âš ï¸ é‡è¦æé†’**: ä¿®æ”¹åŸºç¡€è®¾æ–½é…ç½®å‰å¿…é¡»é€šçŸ¥æ‰€æœ‰ç›¸å…³æ¨¡å—