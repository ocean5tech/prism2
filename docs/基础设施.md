# Prism2 基础设施软件清单

## 文档信息
- **创建时间**: 2025-09-16
- **最后更新**: 2025-09-16 12:15:00
- **状态**: ✅ 已安装完成 (核心组件已部署)
- **负责人**: 开发团队
- **安装日志**: 详见 `/docs/基础设施.log`

## 容器化平台

### Podman Engine
- **软件名称**: Podman
- **版本要求**: >= 4.0.0
- **实际版本**: ✅ 4.9.3 (已安装)
- **用途**: 无守护进程容器运行时环境
- **官方URL**: https://podman.io/
- **安装命令**: `sudo apt update && sudo apt install -y podman`
- **实际安装路径**: `/usr/bin/podman`
- **系统要求**: Linux 内核 >= 3.10
- **资源占用**: ~136MB 磁盘空间 (实际)
- **优势**: 无需root权限，兼容Docker命令
- **安装状态**: ✅ 安装成功，配置完成

### Podman Compose
- **软件名称**: Podman Compose
- **版本要求**: >= 1.0.0
- **用途**: 多容器应用编排
- **官方URL**: https://github.com/containers/podman-compose
- **安装命令**: `pip install podman-compose`
- **预期安装路径**: Python site-packages
- **依赖关系**: 依赖 Podman Engine
- **资源占用**: ~30MB 磁盘空间

## 数据库系统

### PostgreSQL
- **软件名称**: PostgreSQL
- **版本要求**: 15.x
- **实际版本**: ✅ 15.13 + TimescaleDB (已安装)
- **用途**: 主数据库，存储股票数据、用户信息
- **官方URL**: https://www.postgresql.org/
- **容器镜像**: `docker.io/timescale/timescaledb:latest-pg15`
- **实际安装路径**: `/var/lib/postgresql/data` (容器内)
- **端口**: 5432 (固定，不可修改)
- **资源占用**: ~1GB 内存，~10GB 磁盘空间
- **配置要求**:
  - shared_buffers: 256MB
  - effective_cache_size: 1GB
- **安装状态**: ✅ 容器运行正常，TimescaleDB扩展已激活

### TimescaleDB Extension
- **软件名称**: TimescaleDB
- **版本要求**: >= 2.11.0
- **用途**: PostgreSQL时序数据扩展
- **官方URL**: https://www.timescale.com/
- **容器镜像**: `docker.io/timescale/timescaledb:latest-pg15`
- **预期安装路径**: PostgreSQL扩展目录
- **端口**: 5432 (与PostgreSQL共享)
- **依赖关系**: 依赖 PostgreSQL 15
- **用途说明**: 优化K线数据和时序指标存储

### Redis
- **软件名称**: Redis
- **版本要求**: 7.x
- **实际版本**: ✅ 7-alpine (已安装)
- **用途**: 缓存系统，会话存储
- **官方URL**: https://redis.io/
- **容器镜像**: `docker.io/redis:7-alpine`
- **实际安装路径**: `/data` (容器内)
- **端口**: 6379 (固定，不可修改)
- **资源占用**: ~512MB 内存，~1GB 磁盘空间
- **配置要求**:
  - maxmemory: 512mb
  - maxmemory-policy: allkeys-lru
- **安装状态**: ✅ 容器运行正常，连接测试通过 (PING→PONG)

## Web服务器

### Nginx
- **软件名称**: Nginx
- **版本要求**: >= 1.24.0
- **用途**: 反向代理，静态文件服务，负载均衡
- **官方URL**: https://nginx.org/
- **容器镜像**: `docker.io/nginx:alpine`
- **预期安装路径**: `/etc/nginx` (容器内)
- **端口**: 80, 443 (固定，不可修改)
- **资源占用**: ~100MB 内存，~50MB 磁盘空间
- **配置文件**:
  - `/etc/nginx/nginx.conf`
  - `/etc/nginx/conf.d/default.conf`

## AI模型服务

### Ollama
- **软件名称**: Ollama
- **版本要求**: >= 0.1.32
- **实际版本**: ✅ 0.11.11 (已安装)
- **用途**: 本地大语言模型运行环境
- **官方URL**: https://ollama.ai/
- **安装方式**:
  - Linux: `curl -fsSL https://ollama.ai/install.sh | sh`
  - Podman: `docker.io/ollama/ollama:latest`
- **实际安装路径**: `/usr/local/bin/ollama`
- **端口**: 11434 (固定，不可修改)
- **资源占用**: ~1.5-6GB 内存 (单模型运行)，~5.5GB 磁盘空间 (2个模型已下载)
- **GPU要求**: 可选，支持NVIDIA CUDA
- **安装状态**: ✅ 服务运行正常，模型下载完成

### Qwen2.5-7B 模型
- **模型名称**: Qwen2.5-7B
- **版本**: ✅ qwen2.5:7b (已下载)
- **用途**: 中文金融分析文本生成 (主要模型)
- **下载命令**: `ollama pull qwen2.5:7b`
- **模型大小**: ~4.7GB (实际)
- **内存要求**: ~6GB
- **实际存储路径**: `~/.ollama/models/`
- **安装状态**: ✅ 下载完成，可正常使用

### DeepSeek-Coder-1.3B 模型
- **模型名称**: DeepSeek-Coder-1.3B
- **版本**: ✅ deepseek-coder:1.3b (已下载)
- **用途**: 轻量级代码生成和分析 (测试模型)
- **下载命令**: `ollama pull deepseek-coder:1.3b`
- **模型大小**: ~776MB (实际)
- **内存要求**: ~1.5GB
- **实际存储路径**: `~/.ollama/models/`
- **安装状态**: ✅ 下载完成，功能验证通过

### DeepSeek-Coder-6.7B 模型
- **模型名称**: DeepSeek-Coder-6.7B
- **版本**: ⏳ 计划安装 (未下载)
- **用途**: 标准代码生成和分析 (对比模型)
- **下载命令**: `ollama pull deepseek-coder:6.7b`
- **模型大小**: ~3.8GB (预估)
- **内存要求**: ~5GB
- **预期存储路径**: `~/.ollama/models/`
- **安装状态**: ⏳ 待安装 (资源有限时可选)

### bge-large-zh-v1.5 向量模型
- **模型名称**: bge-large-zh-v1.5
- **版本**: v1.5
- **用途**: 中文文本向量化
- **官方URL**: https://huggingface.co/BAAI/bge-large-zh-v1.5
- **模型大小**: ~1.3GB
- **预期存储路径**: `/app/models/bge-large-zh-v1.5`
- **依赖**: Python transformers, sentence-transformers

## 向量数据库

### ChromaDB
- **软件名称**: ChromaDB
- **版本要求**: >= 0.4.0
- **实际版本**: ✅ latest (已安装)
- **用途**: 向量存储和语义搜索
- **官方URL**: https://www.trychroma.com/
- **容器镜像**: `docker.io/chromadb/chroma:latest`
- **实际安装路径**: `/chroma/chroma` (容器内)
- **端口**: 8000 (固定，不可修改)
- **资源占用**: ~1GB 内存，~5GB 磁盘空间
- **安装状态**: ✅ 容器运行正常，API功能验证通过
- **特殊说明**: 已解决代理配置问题，支持RAG功能

## 轻量级数据处理组件

### 数据流架构
```
定时任务(APScheduler) → 爬虫(Scrapy) → 任务队列(Celery+Redis) → 数据处理(Pandas) → 数据库(PostgreSQL)
                                     ↓
                            向量化(bge-large-zh) → 向量库(ChromaDB) → RAG服务
```

### APScheduler
- **软件名称**: APScheduler (Advanced Python Scheduler)
- **版本要求**: >= 3.10.0
- **用途**: 定时爬虫任务调度和数据更新
- **官方URL**: https://apscheduler.readthedocs.io/
- **安装命令**:
  ```bash
  pip install apscheduler==3.10.4
  ```
- **配置示例**:
  ```python
  from apscheduler.schedulers.blocking import BlockingScheduler
  scheduler = BlockingScheduler()
  # 每日9点执行新闻爬取
  scheduler.add_job(crawl_news, 'cron', hour=9)
  ```
- **预期安装路径**: Python site-packages
- **资源占用**: ~50MB 内存，~10MB 磁盘空间
- **调度策略**: 支持cron表达式、间隔执行等

### SQLite (轻量级队列)
- **软件名称**: SQLite
- **版本要求**: >= 3.40.0
- **用途**: 轻量级任务队列和临时数据存储
- **官方URL**: https://www.sqlite.org/
- **安装方式**: Python内置sqlite3模块
- **预期安装路径**: 项目数据目录
- **资源占用**: ~20MB 内存，~100MB 磁盘空间
- **用途说明**: 简单的消息队列实现，替代Kafka

### Pandas + NumPy (数据处理)
- **软件名称**: Pandas + NumPy
- **版本要求**: pandas >= 2.0.0, numpy >= 1.24.0
- **用途**: 轻量级数据处理和分析，替代Spark
- **官方URL**: https://pandas.pydata.org/
- **安装命令**:
  ```bash
  pip install pandas==2.1.4 numpy==1.26.2
  ```
- **使用场景**:
  - K线数据清洗和转换
  - 技术指标计算 (MA, MACD, RSI等)
  - 股票数据统计分析
- **预期安装路径**: Python site-packages
- **资源占用**: ~200MB 内存，~100MB 磁盘空间

## 开发工具

### Python 运行环境
- **软件名称**: Python
- **版本要求**: 3.12.x
- **用途**: 后端服务开发语言
- **官方URL**: https://www.python.org/
- **容器镜像**: `python:3.12-slim`
- **包管理**: pip, requirements.txt
- **虚拟环境**: venv 或 poetry

### Node.js 运行环境
- **软件名称**: Node.js
- **版本要求**: >= 18.x LTS
- **用途**: 前端构建和开发
- **官方URL**: https://nodejs.org/
- **容器镜像**: `node:18-alpine`
- **包管理**: npm 或 yarn
- **预期安装路径**: `/usr/local/bin/node`

## 监控工具 (可选)

### Scrapy (爬虫框架)
- **软件名称**: Scrapy
- **版本要求**: >= 2.8.0
- **用途**: 股票新闻、公告、研报数据爬取
- **官方URL**: https://scrapy.org/
- **安装命令**:
  ```bash
  pip install scrapy==2.11.0 requests==2.31.0 beautifulsoup4==4.12.2 lxml==4.9.3
  ```
- **预期安装路径**: Python site-packages
- **资源占用**: ~100MB 内存，~50MB 磁盘空间
- **目标网站**: 东方财富、新浪财经、雪球等
- **功能特性**: 反爬虫策略、并发控制、数据清洗

### Celery (异步任务队列)
- **软件名称**: Celery
- **版本要求**: >= 5.3.0
- **用途**: 爬虫任务异步执行，替代Kafka消息队列
- **官方URL**: https://docs.celeryq.dev/
- **安装命令**:
  ```bash
  pip install celery[redis]==5.3.4
  ```
- **启动命令**:
  ```bash
  # Worker进程
  celery -A app.celery worker --loglevel=info
  # 监控界面
  celery -A app.celery flower --port=5555
  ```
- **预期安装路径**: Python site-packages
- **资源占用**: ~80MB 内存，~30MB 磁盘空间
- **依赖关系**: 使用Redis作为消息代理器

### Open WebUI
- **软件名称**: Open WebUI
- **版本要求**: 最新版
- **实际版本**: ✅ main (已安装)
- **用途**: LLM模型管理和调试界面，支持多模型切换
- **官方URL**: https://github.com/open-webui/open-webui
- **容器镜像**: `ghcr.io/open-webui/open-webui:main`
- **端口**: 3000 (实际使用)
- **资源占用**: ~200MB 内存，~100MB 磁盘空间
- **依赖关系**: 依赖 Ollama
- **支持模型**: Qwen2.5-7B, DeepSeek-Coder-1.3B
- **安装状态**: ✅ 容器下载完成，等待验证

### Redis Commander (Redis管理)
- **软件名称**: Redis Commander
- **版本要求**: 最新版
- **用途**: Redis数据库Web管理界面
- **官方URL**: https://github.com/joeferner/redis-commander
- **容器镜像**: `docker.io/rediscommander/redis-commander:latest`
- **端口**: 8081 (固定，不可修改)
- **资源占用**: ~50MB 内存，~30MB 磁盘空间
- **依赖关系**: 依赖 Redis

### Flower (Celery监控)
- **软件名称**: Flower
- **版本要求**: >= 2.0.0
- **用途**: Celery任务队列Web监控界面
- **官方URL**: https://flower.readthedocs.io/
- **安装命令**:
  ```bash
  pip install flower==2.0.1
  ```
- **启动命令**:
  ```bash
  celery -A app.celery flower --port=5555
  ```
- **端口**: 5555 (固定，不可修改)
- **监控功能**: 任务状态、队列长度、Worker的性能、失败任务重试
- **资源占用**: ~60MB 内存，~20MB 磁盘空间
- **依赖关系**: 依赖 Celery + Redis

## 总体资源需求

### 最小配置 (轻量模型)
- **CPU**: 4核心
- **内存**: 6GB (DeepSeek-1.3B + 爬虫组件)
- **磁盘**: 30GB
- **网络**: 100Mbps
- **注意**: 不需要Adminer（使用Windows pgAdmin4）

### 推荐配置 (标准模型)
- **CPU**: 6核心
- **内存**: 10GB (Qwen2.5-7B 单模型 + 缓冲)
- **磁盘**: 50GB SSD
- **网络**: 1000Mbps
- **GPU**: 可选 (Ollama加速)

### 模型切换说明
- Ollama支持动态模型加载/卸载
- 在Open WebUI中切换模型时，旧模型会自动释放内存
- 建议优先使用DeepSeek-1.3B进行测试，需要时再切换大模型

## 网络端口规划 (固定分配，不可修改)

| 服务 | 端口 | 协议 | 用途 | 安装状态 |
|------|------|------|------|----------|
| Nginx | 80, 443 | HTTP/HTTPS | Web入口 | ⏳ 待安装 |
| PostgreSQL | 5432 | TCP | 数据库连接 | ✅ 运行中 |
| Redis | 6379 | TCP | 缓存服务 | ✅ 运行中 |
| Ollama | 11434 | HTTP | AI模型API | ✅ 运行中 |
| ChromaDB | 8000 | HTTP | 向量数据库 | ✅ 运行中 |
| Celery Flower | 5555 | HTTP | 任务队列监控 | ⏳ 待安装 |
| Redis Commander | 8081 | HTTP | Redis管理 | ⏳ 待安装 |
| Open WebUI | 3000 | HTTP | LLM管理 (多模型) | ✅ 已下载 |

**最后更新时间**: 2025-09-16 12:15:00
**当前运行服务**: PostgreSQL(5432), Redis(6379), Ollama(11434), ChromaDB(8000)
**验证方法**: `podman ps` 查看运行状态

## 安装顺序建议

1. **阶段1**: Podman Engine + Podman Compose
2. **阶段2**: 数据库 (PostgreSQL, Redis)
3. **阶段3**: Web服务器 (Nginx)
4. **阶段4**: AI服务 (Ollama + 3个模型, ChromaDB)
5. **阶段5**: Python数据处理库 (APScheduler, Pandas)
6. **阶段6**: 监控工具 (Open WebUI, Redis Commander, Celery Flower)

## 完整软件包清单和安装命令

### 系统基础包
```bash
# Ubuntu/Debian 系统包
sudo apt update && sudo apt install -y \
    curl wget git vim htop tree unzip \
    software-properties-common apt-transport-https \
    ca-certificates gnupg lsb-release
```

### Python 环境和依赖
```bash
# Python 3.12 安装
sudo add-apt-repository ppa:deadsnakes/ppa -y
sudo apt update
sudo apt install -y python3.12 python3.12-dev python3.12-venv python3-pip

# Python 依赖包 (requirements.txt)
pip install \
    fastapi==0.104.1 \
    uvicorn[standard]==0.24.0 \
    psycopg2-binary==2.9.9 \
    redis==5.0.1 \
    langchain==0.0.339 \
    chromadb==0.4.18 \
    scrapy==2.11.0 \
    celery[redis]==5.3.4 \
    flower==2.0.1 \
    apscheduler==3.10.4 \
    pandas==2.1.4 \
    requests==2.31.0 \
    beautifulsoup4==4.12.2
```

### 容器和镜像
```bash
# Podman 安装
sudo apt install -y podman
pip3 install podman-compose

# 容器镜像拉取
podman pull docker.io/timescale/timescaledb:latest-pg15
podman pull docker.io/redis:7-alpine
podman pull docker.io/chromadb/chroma:latest
podman pull docker.io/nginx:alpine
podman pull docker.io/rediscommander/redis-commander:latest
podman pull ghcr.io/open-webui/open-webui:main
```

### AI 模型
```bash
# Ollama 安装
curl -fsSL https://ollama.ai/install.sh | sh

# 模型下载
ollama pull deepseek-coder:1.3b-instruct  # 轻量模型
ollama pull qwen2.5:7b-instruct           # 主要模型
ollama pull deepseek-coder:6.7b-instruct  # 对比模型
```

### Node.js 环境
```bash
# Node.js 18 LTS
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs
```

---

## 自动化部署

**详细部署指南**: 请参考 `/docs/自动化部署指南.md`

**一键部署命令**:
```bash
# 下载部署脚本
wget https://raw.githubusercontent.com/your-repo/prism2/main/scripts/deploy.sh
chmod +x deploy.sh
./deploy.sh
```

**适用场景**: AI助手、系统管理员、DevOps工程师可使用此文档在新机器上完整复现系统。

---

## 📋 实际安装记录 (2025-09-16)

### 安装总结
**安装时间**: 2025-09-16 10:20:00 - 12:00:00 (约1小时40分钟)
**安装方式**: 手动安装 + 容器部署
**操作系统**: Ubuntu 24.04 WSL2
**最终状态**: 核心组件全部安装成功

### 成功安装的组件
| 组件 | 版本 | 状态 | 验证方法 |
|------|------|------|----------|
| Podman | 4.9.3 | ✅ 正常 | `podman --version` |
| PostgreSQL + TimescaleDB | 15.13 | ✅ 正常 | `podman logs prism2-postgres` |
| Redis | 7-alpine | ✅ 正常 | `redis-cli ping` → PONG |
| Ollama | 0.11.11 | ✅ 正常 | `ollama list` |
| Qwen2.5-7B | 4.7GB | ✅ 正常 | 大模型响应测试 |
| DeepSeek-Coder-1.3B | 776MB | ✅ 正常 | 轻量模型响应测试 |
| ChromaDB | latest | ✅ 正常 | `/home/wyatt/prism2/test_chromadb.py` |
| Open WebUI | main | ✅ 正常 | 容器下载完成 |
| Python 3.12 | 3.12.3 | ✅ 正常 | `python3 --version` |

### 资源使用情况
- **磁盘使用**: 14GB / 1007GB (2%使用)
- **内存使用**: 5.9GB / 7.6GB (77%使用，1.8GB可用)
- **主要消耗**: Ollama模型(5.5GB) + 容器镜像(3.5GB) + Python环境(0.16GB)

### 关键问题解决
1. **代理服务器问题**: 企业环境代理影响GitHub下载和容器网络
   - **解决**: 临时清除代理环境变量
   - **命令**: `export http_proxy="" https_proxy="" HTTP_PROXY="" HTTPS_PROXY=""`

2. **ChromaDB API访问问题**: 403 Forbidden错误
   - **根因**: 容器继承代理设置
   - **解决**: 重新启动容器并清除代理

3. **Python环境管理**: Ubuntu 24.04的externally-managed-environment
   - **解决**: 使用虚拟环境 `python3 -m venv ~/prism2/venv`

### 验证脚本
创建的验证工具:
- `/home/wyatt/prism2/test_chromadb.py` - ChromaDB功能验证
- 各服务的连接测试命令

### 经验教训
- ⚠️ **必读文档**: `/docs/LessonsLearned.md` - 避免重复问题
- 🔧 **代理配置**: 企业环境下务必检查和清除代理设置
- 📊 **资源监控**: 7.6GB内存可支持标准配置，建议16GB以上
- 🐛 **问题记录**: 所有问题和解决方案已记录在经验教训文档中

**详细安装日志**: 参见 `/docs/基础设施.log`