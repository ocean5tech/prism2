# Prism2 系统自动化部署指南

## 文档信息
- **创建时间**: 2025-09-16
- **适用环境**: Ubuntu 20.04+ / WSL2
- **目标用户**: AI助手、系统管理员、开发者
- **部署时间**: 约2-3小时

## 系统要求

### 硬件要求
```bash
# 最小配置
CPU: 4核心
内存: 6GB (轻量模型) / 10GB (标准模型)
磁盘: 30GB 可用空间
网络: 100Mbps

# 推荐配置
CPU: 6核心
内存: 12GB
磁盘: 50GB SSD
网络: 1000Mbps
```

### 操作系统要求
```bash
# 检查系统版本
lsb_release -a
# 要求: Ubuntu 20.04+ 或兼容发行版

# 检查内核版本
uname -r
# 要求: Linux 内核 >= 3.10
```

## 预安装检查脚本

```bash
#!/bin/bash
# 文件名: pre_install_check.sh

echo "=== Prism2 预安装系统检查 ==="

# 检查操作系统
OS_VERSION=$(lsb_release -rs)
echo "操作系统版本: Ubuntu $OS_VERSION"
if (( $(echo "$OS_VERSION >= 20.04" | bc -l) )); then
    echo "✅ 操作系统版本符合要求"
else
    echo "❌ 操作系统版本过低，需要 Ubuntu 20.04+"
    exit 1
fi

# 检查内存
MEMORY_GB=$(free -g | awk '/^Mem:/{print $2}')
echo "系统内存: ${MEMORY_GB}GB"
if [ $MEMORY_GB -ge 6 ]; then
    echo "✅ 内存充足"
else
    echo "❌ 内存不足，最少需要6GB"
    exit 1
fi

# 检查磁盘空间
DISK_SPACE_GB=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
echo "可用磁盘空间: ${DISK_SPACE_GB}GB"
if [ $DISK_SPACE_GB -ge 30 ]; then
    echo "✅ 磁盘空间充足"
else
    echo "❌ 磁盘空间不足，最少需要30GB"
    exit 1
fi

# 检查端口占用
PORTS=(5432 6379 80 443 11434 8000 8081 3001 5555)
echo "检查端口占用状态:"
for port in "${PORTS[@]}"; do
    if ss -tuln | grep -q ":$port "; then
        echo "❌ 端口 $port 已被占用"
        exit 1
    else
        echo "✅ 端口 $port 可用"
    fi
done

echo "🎉 系统检查通过，可以开始安装！"
```

## 第一阶段：系统基础环境

### 1.1 更新系统包
```bash
# 更新包索引
sudo apt update && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y \
    curl \
    wget \
    git \
    vim \
    htop \
    tree \
    unzip \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release
```

### 1.2 安装Python 3.12环境
```bash
# 添加deadsnakes PPA源
sudo add-apt-repository ppa:deadsnakes/ppa -y
sudo apt update

# 安装Python 3.12
sudo apt install -y \
    python3.12 \
    python3.12-dev \
    python3.12-venv \
    python3-pip

# 设置Python 3.12为默认版本
sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1
sudo update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1

# 验证安装
python --version  # 应显示 Python 3.12.x
pip3 --version
```

### 1.3 安装Node.js 18 LTS
```bash
# 安装NodeSource仓库
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -

# 安装Node.js
sudo apt install -y nodejs

# 验证安装
node --version  # 应显示 v18.x.x
npm --version
```

## 第二阶段：容器化平台

### 2.1 安装Podman
```bash
# 安装Podman
sudo apt update
sudo apt install -y podman

# 配置Podman注册表
sudo mkdir -p /etc/containers
cat << 'EOF' | sudo tee /etc/containers/registries.conf
[registries.search]
registries = ['docker.io', 'quay.io']

[registries.insecure]
registries = []

[registries.block]
registries = []
EOF

# 验证安装
podman --version
podman info
```

### 2.2 安装Podman Compose
```bash
# 安装pip包管理器（如果未安装）
sudo apt install -y python3-pip

# 安装podman-compose
pip3 install podman-compose

# 验证安装
podman-compose --version

# 创建别名方便使用
echo 'alias docker-compose=podman-compose' >> ~/.bashrc
echo 'alias docker=podman' >> ~/.bashrc
source ~/.bashrc
```

## 第三阶段：数据库服务

### 3.1 启动PostgreSQL容器
```bash
# 创建数据目录
mkdir -p ~/prism2/data/postgres

# 启动PostgreSQL容器
podman run -d \
    --name prism2-postgres \
    --restart unless-stopped \
    -p 5432:5432 \
    -e POSTGRES_DB=prism2 \
    -e POSTGRES_USER=prism2 \
    -e POSTGRES_PASSWORD=prism2_secure_password \
    -v ~/prism2/data/postgres:/var/lib/postgresql/data \
    docker.io/timescale/timescaledb:latest-pg15

# 验证启动
podman ps | grep postgres
podman logs prism2-postgres
```

### 3.2 启动Redis容器
```bash
# 创建数据目录
mkdir -p ~/prism2/data/redis

# 启动Redis容器
podman run -d \
    --name prism2-redis \
    --restart unless-stopped \
    -p 6379:6379 \
    -v ~/prism2/data/redis:/data \
    docker.io/redis:7-alpine \
    redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru

# 验证启动
podman ps | grep redis
podman exec prism2-redis redis-cli ping  # 应返回 PONG
```

## 第四阶段：AI模型服务

### 4.1 安装Ollama
```bash
# 下载并安装Ollama
curl -fsSL https://ollama.ai/install.sh | sh

# 启动Ollama服务
sudo systemctl enable ollama
sudo systemctl start ollama

# 验证服务状态
sudo systemctl status ollama
curl http://localhost:11434/api/version
```

### 4.2 下载AI模型
```bash
# 下载DeepSeek-1.3B（轻量模型，优先）
ollama pull deepseek-coder:1.3b-instruct

# 下载Qwen2.5-7B（主要模型）
ollama pull qwen2.5:7b-instruct

# 下载DeepSeek-6.7B（对比模型）
ollama pull deepseek-coder:6.7b-instruct

# 验证模型下载
ollama list
```

### 4.3 启动ChromaDB
```bash
# 创建数据目录
mkdir -p ~/prism2/data/chromadb

# 启动ChromaDB容器
podman run -d \
    --name prism2-chromadb \
    --restart unless-stopped \
    -p 8000:8000 \
    -v ~/prism2/data/chromadb:/chroma/chroma \
    docker.io/chromadb/chroma:latest

# 验证启动
podman ps | grep chromadb
curl http://localhost:8000/api/v1/version
```

## 第五阶段：Python环境和依赖

### 5.1 创建虚拟环境
```bash
# 创建项目目录
mkdir -p ~/prism2
cd ~/prism2

# 创建Python虚拟环境
python3.12 -m venv prism2_env

# 激活虚拟环境
source prism2_env/bin/activate

# 升级pip
pip install --upgrade pip
```

### 5.2 安装Python依赖包
```bash
# 创建requirements.txt文件
cat << 'EOF' > requirements.txt
# Web框架
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.0

# 数据库
psycopg2-binary==2.9.9
redis==5.0.1
sqlalchemy==2.0.23
alembic==1.13.1

# AI和向量化
langchain==0.0.339
langchain-community==0.0.1
chromadb==0.4.18
sentence-transformers==2.2.2
transformers==4.36.2

# 爬虫和数据处理
scrapy==2.11.0
requests==2.31.0
beautifulsoup4==4.12.2
lxml==4.9.3
pandas==2.1.4
numpy==1.26.2

# 任务队列
celery[redis]==5.3.4
flower==2.0.1

# 调度器
apscheduler==3.10.4

# 实用工具
python-dotenv==1.0.0
pyyaml==6.0.1
python-multipart==0.0.6
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4

# 开发工具
pytest==7.4.3
pytest-asyncio==0.21.1
black==23.11.0
flake8==6.1.0
EOF

# 安装依赖包
pip install -r requirements.txt

# 验证安装
python -c "import fastapi, scrapy, celery, pandas; print('✅ 所有Python包安装成功')"
```

## 第六阶段：Web服务和管理工具

### 6.1 启动Nginx
```bash
# 创建配置目录
mkdir -p ~/prism2/config/nginx

# 创建基础Nginx配置
cat << 'EOF' > ~/prism2/config/nginx/default.conf
server {
    listen 80;
    server_name localhost;

    # 前端静态文件
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api/ {
        proxy_pass http://host.containers.internal:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Ollama代理
    location /ollama/ {
        proxy_pass http://host.containers.internal:11434/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
EOF

# 启动Nginx容器
podman run -d \
    --name prism2-nginx \
    --restart unless-stopped \
    -p 80:80 \
    -p 443:443 \
    -v ~/prism2/config/nginx/default.conf:/etc/nginx/conf.d/default.conf \
    docker.io/nginx:alpine

# 验证启动
podman ps | grep nginx
curl http://localhost
```

### 6.2 启动管理工具
```bash
# 启动Redis Commander
podman run -d \
    --name prism2-redis-commander \
    --restart unless-stopped \
    -p 8081:8081 \
    -e REDIS_HOSTS=host.containers.internal:6379 \
    docker.io/rediscommander/redis-commander:latest

# 启动Open WebUI
podman run -d \
    --name prism2-open-webui \
    --restart unless-stopped \
    -p 3001:8080 \
    -e OLLAMA_BASE_URL=http://host.containers.internal:11434 \
    -v ~/prism2/data/open-webui:/app/backend/data \
    ghcr.io/open-webui/open-webui:main

# 验证启动
podman ps | grep commander
podman ps | grep open-webui
```

## 第七阶段：启动应用服务

### 7.1 启动Celery Worker和Flower
```bash
# 在prism2虚拟环境中启动
cd ~/prism2
source prism2_env/bin/activate

# 启动Celery Worker（后台运行）
celery -A app.celery worker --loglevel=info --detach

# 启动Flower监控（后台运行）
celery -A app.celery flower --port=5555 --detach

# 验证启动
ps aux | grep celery
curl http://localhost:5555
```

## 验证部署清单

### 服务状态检查
```bash
#!/bin/bash
# 文件名: check_services.sh

echo "=== Prism2 服务状态检查 ==="

# 检查容器状态
echo "📦 容器服务:"
services=(prism2-postgres prism2-redis prism2-chromadb prism2-nginx prism2-redis-commander prism2-open-webui)
for service in "${services[@]}"; do
    if podman ps --format "{{.Names}}" | grep -q "$service"; then
        echo "✅ $service 运行中"
    else
        echo "❌ $service 未运行"
    fi
done

# 检查端口
echo "🌐 端口检查:"
ports=(5432 6379 8000 11434 80 8081 3001 5555)
for port in "${ports[@]}"; do
    if ss -tuln | grep -q ":$port "; then
        echo "✅ 端口 $port 已监听"
    else
        echo "❌ 端口 $port 未监听"
    fi
done

# 检查AI模型
echo "🤖 AI模型:"
if command -v ollama &> /dev/null; then
    ollama list | grep -E "(deepseek|qwen)" || echo "❌ 模型未下载"
else
    echo "❌ Ollama未安装"
fi

# 检查Python环境
echo "🐍 Python环境:"
if [ -f ~/prism2/prism2_env/bin/activate ]; then
    source ~/prism2/prism2_env/bin/activate
    python -c "import fastapi, scrapy, celery; print('✅ Python依赖正常')" 2>/dev/null || echo "❌ Python依赖缺失"
    deactivate
else
    echo "❌ Python虚拟环境不存在"
fi

echo "🏁 检查完成！"
```

## 访问地址汇总

```bash
# 应用服务
PostgreSQL数据库: localhost:5432 (用pgAdmin4连接)
Redis缓存: localhost:6379
ChromaDB向量库: http://localhost:8000

# AI服务
Ollama API: http://localhost:11434
Open WebUI (模型切换): http://localhost:3001

# 管理界面
Redis Commander: http://localhost:8081
Flower (Celery监控): http://localhost:5555
主应用入口: http://localhost:80

# 默认凭据
PostgreSQL: 用户名=prism2, 密码=prism2_secure_password, 数据库=prism2
```

## 故障排除

### 常见问题解决
```bash
# 内存不足
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 端口冲突
sudo ss -tulpn | grep :端口号  # 查看占用进程
sudo kill -9 PID  # 终止进程

# 容器无法启动
podman logs 容器名  # 查看日志
podman restart 容器名  # 重启容器

# Python依赖冲突
pip install --force-reinstall 包名
```

## 备份和恢复

### 数据备份脚本
```bash
#!/bin/bash
# 文件名: backup_system.sh

BACKUP_DIR=~/prism2_backup_$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# 备份PostgreSQL数据
podman exec prism2-postgres pg_dump -U prism2 prism2 > $BACKUP_DIR/postgres_backup.sql

# 备份配置文件
cp -r ~/prism2/config $BACKUP_DIR/
cp ~/prism2/requirements.txt $BACKUP_DIR/

# 备份AI模型列表
ollama list > $BACKUP_DIR/ollama_models.txt

echo "备份完成: $BACKUP_DIR"
```

---

**部署完成后，系统管理员或AI助手可以使用这份文档在任何兼容的Linux环境中完整复现Prism2系统。**