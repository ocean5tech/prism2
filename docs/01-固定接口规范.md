# 01-å›ºå®šæ¥å£è§„èŒƒ

> **ä¸¥ç¦å½“ä¸€ä¸ªæ¥å£è¢«å ç”¨å°±å»ç”¨æœªç»å…è®¸çš„å…¶ä»–æ¥å£**
>
> æœ¬æ–‡æ¡£å®šä¹‰çš„æ‰€æœ‰æ¥å£**ä¸€æ—¦ç¡®å®šä¸å…è®¸ä¿®æ”¹**ï¼Œæ‰€æœ‰æ¨¡å—å¿…é¡»ä¸¥æ ¼éµå®ˆ

## ğŸŒ ç«¯å£åˆ†é…ï¼ˆä¸¥æ ¼å›ºå®šï¼‰

| æœåŠ¡ | ç«¯å£ | åè®® | ç”¨é€” | çŠ¶æ€ |
|------|------|------|------|------|
| Frontend (Main Page) | 3000 | HTTP | Google-likeä¸»é¡µé¢ | å¿…é¡» |
| Open WebUI | 3001 | HTTP | AIèŠå¤©ç•Œé¢ | å¿…é¡» |
| Backend (Http API) | 8000 | HTTP | æ ¸å¿ƒä¸šåŠ¡API | å¿…é¡» |
| RAG Service | 8001 | HTTP | å‘é‡æ£€ç´¢æœåŠ¡ | å¿…é¡» |
| Push Service | 8002 | HTTP/WS | æ¨é€æœåŠ¡ | å¿…é¡» |
| ChromaDB | 8003 | HTTP | å‘é‡æ•°æ®åº“ | å¿…é¡» |
| MCPOä»£ç† | 8005 | HTTP | MCPåˆ°OpenAPIä»£ç† | å¿…é¡» |
| Prism2 MCP Server | 8006 | HTTP | è‚¡ç¥¨åˆ†æMCPæœåŠ¡ | å¿…é¡» |
| Enhanced Dashboard API | 8081 | HTTP | å¢å¼ºæ•°æ®ä»ªè¡¨æ¿ | å¿…é¡» |
| Redis | 6379 | TCP | ç¼“å­˜æœåŠ¡ | å…±äº« |
| PostgreSQL | 5432 | TCP | æ•°æ®åº“æœåŠ¡ | å…±äº« |
| Nginx | 9080 | HTTP | åå‘ä»£ç† | å¿…é¡» |
| å¤§è¯­è¨€æ¨¡å‹ | 11434 | HTTP | Ollama/Qwen/Deepseek | å¿…é¡» |

## ğŸ“¡ æ¨¡å—é—´APIæ¥å£ï¼ˆå›ºå®šä¸å˜ï¼‰

### 1. Frontend â†’ Backend API
```
åŸºç¡€è·¯å¾„: http://backend:8000/api/v1/

GET  /stocks/search          # è‚¡ç¥¨æœç´¢
GET  /stocks/{code}/info     # åŸºç¡€ä¿¡æ¯
GET  /stocks/{code}/realtime # å®æ—¶ä»·æ ¼
POST /stocks/dashboard       # Dashboardç»¼åˆæ•°æ®
WS   /ws/stocks/realtime     # å®æ—¶æ•°æ®æ¨é€
```

### 2. Backend â†’ RAG Service API
```
åŸºç¡€è·¯å¾„: http://rag-service:8001/api/v1/

POST /search                 # å‘é‡æœç´¢
POST /vectorize              # æ–‡æ¡£å‘é‡åŒ–
GET  /health                 # å¥åº·æ£€æŸ¥
```

### 3. Backend â†’ AI Service API
```
åŸºç¡€è·¯å¾„: http://ai-service:11434/api/

POST /generate              # AIåˆ†æç”Ÿæˆ
POST /embeddings            # å‘é‡ç”Ÿæˆ
GET  /models                # æ¨¡å‹åˆ—è¡¨
```

### 4. Push Service API
```
åŸºç¡€è·¯å¾„: http://push-service:8002/api/v1/

POST /subscribe             # è®¢é˜…æ¨é€
POST /unsubscribe           # å–æ¶ˆè®¢é˜…
POST /broadcast             # å¹¿æ’­æ¶ˆæ¯
WS   /push                  # WebSocketæ¨é€
```

### 5. MCP Service API (æ–°å¢)
```
åŸºç¡€è·¯å¾„: http://mcpo-proxy:8005/api/

GET  /tools                 # MCPå·¥å…·åˆ—è¡¨
POST /tools/{tool_name}     # è°ƒç”¨MCPå·¥å…·
GET  /openapi.json          # OpenAPIè§„èŒƒæ–‡æ¡£
```

### 6. Enhanced Dashboard API (æ–°å¢)
```
åŸºç¡€è·¯å¾„: http://enhanced-api:8081/api/v1/

POST /stocks/dashboard      # ç»¼åˆè‚¡ç¥¨æ•°æ®è·å–
GET  /                      # å¥åº·æ£€æŸ¥
```

## ğŸ—„ï¸ æ•°æ®åº“æ¥å£ï¼ˆå…±äº«PostgreSQLï¼‰

### æ ¸å¿ƒè¡¨ç»“æ„ï¼ˆä¸¥æ ¼å›ºå®šï¼‰
```sql
-- è‚¡ç¥¨åŸºç¡€ä¿¡æ¯
stocks (code, name, market, industry, ...)

-- Kçº¿æ•°æ®
ohlcv_data (stock_code, period, timestamp, ohlcv, ...)

-- è´¢åŠ¡æ•°æ®
financial_reports (stock_code, period, revenue, profit, ...)

-- å…¬å¸å…¬å‘Š
company_announcements (stock_code, title, type, date, ...)

-- è‚¡ç¥¨æ–°é—»
stock_news (stock_code, title, content, publish_time, ...)

-- é¾™è™æ¦œæ•°æ®
longhubang_data (stock_code, trade_date, buy_amount, ...)

-- è‚¡ä¸œå˜æ›´
shareholder_changes (stock_code, shareholder, change_type, ...)

-- AIåˆ†æç»“æœ
ai_analysis_results (stock_code, analysis_type, scores, ...)
```

## ğŸ“¦ Redisç¼“å­˜æ¥å£ï¼ˆå…±äº«Redisï¼‰

### ç¼“å­˜é”®è§„èŒƒï¼ˆä¸¥æ ¼å›ºå®šï¼‰
```python
# è‚¡ç¥¨æ•°æ®ç¼“å­˜ (Database 0)
stock:info:{code}           # åŸºç¡€ä¿¡æ¯ TTL:1å¤©
stock:kline:{code}:{period} # Kçº¿æ•°æ® TTL:30åˆ†é’Ÿ
stock:news:{code}           # æ–°é—»æ•°æ® TTL:4å°æ—¶
stock:analysis:{code}       # AIåˆ†æ TTL:1å¤©

# æœç´¢ç¼“å­˜ (Database 1)
search:{query_hash}         # æœç´¢ç»“æœ TTL:5åˆ†é’Ÿ

# ç³»ç»Ÿç¼“å­˜ (Database 2)
rate:{ip}:{endpoint}        # é™æµ TTL:1åˆ†é’Ÿ
health:{service}            # å¥åº·çŠ¶æ€ TTL:30ç§’
```

## ğŸ“Š Dashboardæ•°æ®ç»„è£…è¯¦è§£

### Dashboard API: POST /stocks/dashboard

#### è¯·æ±‚æ ¼å¼
```json
{
  "stock_code": "000001",
  "data_types": ["basic_info", "realtime", "kline", "financial", "news", "announcements", "longhubang", "ai_analysis"]
}
```

#### æ•°æ®è·å–é€»è¾‘ (æŒ‰ä¸‰çº§ä¼˜å…ˆçº§)
```
1. åŸºç¡€ä¿¡æ¯ (basic_info)
   Redis: stock:info:000001 â†’ PostgreSQL: stocksè¡¨ â†’ AKShare: stock_info_a_code_name()

2. å®æ—¶ä»·æ ¼ (realtime)
   ç›´æ¥AKShare: stock_zh_a_spot_em() [ä¸ç¼“å­˜ï¼Œå®æ—¶è·å–]

3. Kçº¿æ•°æ® (kline)
   Redis: stock:kline:000001:1d â†’ PostgreSQL: ohlcv_dataè¡¨ â†’ AKShare: stock_zh_a_hist()

4. è´¢åŠ¡æ•°æ® (financial)
   Redis: stock:financial:000001 â†’ PostgreSQL: financial_reportsè¡¨ â†’ AKShare: stock_financial_report()

5. æ–°é—»æ•°æ® (news)
   Redis: stock:news:000001 â†’ PostgreSQL: stock_newsè¡¨ â†’ RSSæ–°é—»æºå¤„ç†

6. å…¬å¸å…¬å‘Š (announcements)
   Redis: stock:announcements:000001 â†’ PostgreSQL: company_announcementsè¡¨ â†’ AKShare: stock_announcement()

7. é¾™è™æ¦œæ•°æ® (longhubang)
   Redis: stock:longhubang:000001 â†’ PostgreSQL: longhubang_dataè¡¨ â†’ AKShare: stock_lhb_detail()

8. AIåˆ†æ (ai_analysis)
   Redis: ai:analysis:000001 â†’ PostgreSQL: ai_analysis_resultsè¡¨ â†’ è°ƒç”¨AI Serviceç”Ÿæˆ
```

#### å“åº”æ ¼å¼
```json
{
  "success": true,
  "stock_code": "000001",
  "timestamp": "2025-09-18T15:30:00Z",
  "data": {
    "basic_info": {
      "code": "000001",
      "name": "å¹³å®‰é“¶è¡Œ",
      "market": "SZ",
      "industry": "é“¶è¡Œ",
      "market_cap": 280000000000
    },
    "realtime": {
      "current_price": 12.35,
      "change_percent": 2.15,
      "volume": 150000000,
      "timestamp": "2025-09-18T15:30:00Z"
    },
    "kline": {
      "period": "1d",
      "data": [
        {
          "timestamp": "2025-09-18",
          "open": 12.10,
          "high": 12.40,
          "low": 12.05,
          "close": 12.35,
          "volume": 150000000
        }
      ]
    },
    "financial": {
      "latest_quarter": "2024Q3",
      "revenue": 180000000000,
      "net_profit": 38000000000,
      "roe": 12.5
    },
    "news": [
      {
        "title": "å¹³å®‰é“¶è¡Œå‘å¸ƒä¸‰å­£æŠ¥",
        "summary": "å‡€åˆ©æ¶¦åŒæ¯”å¢é•¿8.2%",
        "publish_time": "2025-09-18T10:00:00Z",
        "sentiment_score": 0.75
      }
    ],
    "announcements": [
      {
        "title": "å…³äºè‘£äº‹ä¼šå†³è®®çš„å…¬å‘Š",
        "type": "é‡å¤§äº‹é¡¹",
        "publish_date": "2025-09-18"
      }
    ],
    "longhubang": {
      "trade_date": "2025-09-17",
      "rank_reason": "æ—¥è·Œå¹…åç¦»å€¼è¾¾7%",
      "buy_amount": 500000000,
      "sell_amount": 300000000
    },
    "ai_analysis": {
      "analysis_type": "comprehensive",
      "six_dimension_scores": {
        "growth": 0.75,
        "profitability": 0.82,
        "risk": 0.65,
        "valuation": 0.70,
        "technical": 0.68,
        "market_sentiment": 0.72
      },
      "investment_recommendation": "ä¹°å…¥",
      "confidence_level": 0.78,
      "summary": "åŸºæœ¬é¢è‰¯å¥½ï¼ŒæŠ€æœ¯é¢åå¼ºï¼Œå»ºè®®å…³æ³¨"
    }
  }
}
```

## ğŸ”„ æ•°æ®æŸ¥è¯¢ä¼˜å…ˆçº§ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰

### ä¸‰çº§æŸ¥è¯¢ç­–ç•¥ï¼ˆä¸å¯æ›´æ”¹ï¼‰
```
1. Redisç¼“å­˜æŸ¥è¯¢ (ä¼˜å…ˆçº§1, <1ms)
   â†“ æœªå‘½ä¸­
2. PostgreSQLæŸ¥è¯¢ (ä¼˜å…ˆçº§2, 10-50ms)
   â†“ ä¸å­˜åœ¨/è¿‡æœŸ
3. AKShare API (ä¼˜å…ˆçº§3, 200-2000ms)
   â†“ æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“
```

### å®æ—¶æ•°æ®ç‰¹æ®Šå¤„ç†

#### Dashboardåˆå§‹åŠ è½½
```
POST /stocks/dashboard â†’ è¿”å›å½“å‰å¿«ç…§æ•°æ® (æ‰€æœ‰æ•°æ®çš„å½“å‰å€¼)
```

#### å®æ—¶æ•°æ®æ¨é€ (WebSocket)
```
æŠ€æœ¯é¢å®æ—¶æ•°æ® â†’ WebSocketä¸»åŠ¨æ¨é€ â†’ Dashboardé¡µé¢å®æ—¶æ›´æ–°

æ¨é€å†…å®¹:
- å®æ—¶ä»·æ ¼ (ä»·æ ¼ã€æ¶¨è·Œå¹…ã€æˆäº¤é‡)
- å®æ—¶æŒ‡æ ‡ (æ¢æ‰‹ç‡ã€æŒ¯å¹…ã€å§”æ¯”ç­‰)
- ç›˜å£æ•°æ® (ä¹°å–äº”æ¡£)
- åˆ†æ—¶å›¾æ•°æ® (æ¯åˆ†é’Ÿæ›´æ–°)

æ¨é€é¢‘ç‡: äº¤æ˜“æ—¶é—´å†…æ¯30ç§’æ¨é€ä¸€æ¬¡
```

### AIåˆ†ææ•°æ®å‡†å¤‡æµç¨‹
```
AIåˆ†æè¯·æ±‚ â†’ æ£€æŸ¥PostgreSQLæ•°æ®å®Œæ•´æ€§ â†’ æ•°æ®ä¸è¶³æ—¶ä»AKShareè¡¥å…¨ â†’ è°ƒç”¨RAG Serviceè·å–ä¸Šä¸‹æ–‡ â†’ è°ƒç”¨AI Serviceç”Ÿæˆåˆ†æ â†’ ç¼“å­˜ç»“æœ
```

## ğŸ“¡ WebSocketå®æ—¶æ¨é€åè®®

### WebSocketè¿æ¥: WS /ws/stocks/realtime

#### å®¢æˆ·ç«¯è®¢é˜…æ¶ˆæ¯
```json
{
  "type": "subscribe",
  "stock_codes": ["000001", "000002", "600519"],
  "data_types": ["price", "volume", "indicators", "orderbook"]
}
```

#### æœåŠ¡ç«¯æ¨é€æ¶ˆæ¯æ ¼å¼

##### 1. å®æ—¶ä»·æ ¼æ¨é€
```json
{
  "type": "price_update",
  "stock_code": "000001",
  "timestamp": "2025-09-18T09:30:15Z",
  "data": {
    "current_price": 12.35,
    "change_amount": 0.15,
    "change_percent": 1.23,
    "volume": 1500000,
    "turnover": 18525000,
    "high": 12.40,
    "low": 12.20,
    "open": 12.25
  }
}
```

##### 2. æŠ€æœ¯æŒ‡æ ‡æ¨é€
```json
{
  "type": "indicators_update",
  "stock_code": "000001",
  "timestamp": "2025-09-18T09:30:15Z",
  "data": {
    "turnover_rate": 0.35,
    "amplitude": 1.65,
    "volume_ratio": 1.2,
    "pe_ratio": 8.5,
    "pb_ratio": 0.7,
    "moving_averages": {
      "ma5": 12.28,
      "ma10": 12.15,
      "ma20": 12.05
    }
  }
}
```

##### 3. ç›˜å£æ•°æ®æ¨é€ (ä¹°å–äº”æ¡£)
```json
{
  "type": "orderbook_update",
  "stock_code": "000001",
  "timestamp": "2025-09-18T09:30:15Z",
  "data": {
    "bid": [
      {"price": 12.34, "volume": 100},
      {"price": 12.33, "volume": 200},
      {"price": 12.32, "volume": 150},
      {"price": 12.31, "volume": 300},
      {"price": 12.30, "volume": 250}
    ],
    "ask": [
      {"price": 12.35, "volume": 80},
      {"price": 12.36, "volume": 120},
      {"price": 12.37, "volume": 90},
      {"price": 12.38, "volume": 200},
      {"price": 12.39, "volume": 180}
    ]
  }
}
```

##### 4. åˆ†æ—¶å›¾æ•°æ®æ¨é€
```json
{
  "type": "minute_data",
  "stock_code": "000001",
  "timestamp": "2025-09-18T09:30:00Z",
  "data": {
    "time": "09:30",
    "price": 12.35,
    "volume": 150000,
    "avg_price": 12.32
  }
}
```

#### å®¢æˆ·ç«¯å–æ¶ˆè®¢é˜…
```json
{
  "type": "unsubscribe",
  "stock_codes": ["000002"]
}
```

#### è¿æ¥å¿ƒè·³
```json
{
  "type": "ping",
  "timestamp": "2025-09-18T09:30:15Z"
}
```

#### æœåŠ¡ç«¯å¿ƒè·³å“åº”
```json
{
  "type": "pong",
  "timestamp": "2025-09-18T09:30:15Z"
}
```

## ğŸš€ å¤–éƒ¨æ•°æ®æºæ¥å£

### AKShare APIè°ƒç”¨ï¼ˆä¸»è¦æ•°æ®æºï¼‰
```python
# å®æ—¶æ•°æ®
ak.stock_zh_a_spot_em()     # å®æ—¶ä»·æ ¼
ak.stock_zh_a_hist()        # å†å²Kçº¿

# åŸºç¡€æ•°æ®
ak.stock_info_a_code_name() # è‚¡ç¥¨åˆ—è¡¨
ak.stock_individual_info()  # å…¬å¸ä¿¡æ¯

# è´¢åŠ¡æ•°æ®
ak.stock_financial_report() # è´¢åŠ¡æŠ¥è¡¨
ak.stock_announcement()      # å…¬å¸å…¬å‘Š
```

### RSSæ–°é—»æºï¼ˆè¾…åŠ©æ•°æ®æºï¼‰
```
æ–°æµªè´¢ç»RSS: http://rss.sina.com.cn/roll/finance/hot_roll.xml
(å…¶ä»–RSSæºå·²å¤±æ•ˆï¼Œä»…ä¿ç•™æ­¤ä¸€ä¸ªæœ‰æ•ˆæº)
```

## âš ï¸ æ¥å£ä½¿ç”¨åŸåˆ™

1. **ä¸¥ç¦éšæ„æ›´æ”¹** - æ¥å£ä¸€æ—¦å®šä¹‰ï¼Œä»»ä½•æ¨¡å—ä¸å¾—ç§è‡ªä¿®æ”¹
2. **ç‰ˆæœ¬æ§åˆ¶** - APIå˜æ›´å¿…é¡»é€šè¿‡ç‰ˆæœ¬å·åŒºåˆ† (/api/v1/, /api/v2/)
3. **ç»Ÿä¸€é”™è¯¯ç ** - æ‰€æœ‰APIä½¿ç”¨ç»Ÿä¸€çš„HTTPçŠ¶æ€ç å’Œé”™è¯¯æ ¼å¼
4. **æ¥å£æ–‡æ¡£å…ˆè¡Œ** - æ–°æ¥å£å¿…é¡»å…ˆæ›´æ–°æ­¤æ–‡æ¡£ï¼Œè·å¾—æ‰¹å‡†åæ‰èƒ½å®ç°
5. **å‘åå…¼å®¹** - æ–°ç‰ˆæœ¬APIå¿…é¡»ä¿æŒå¯¹æ—§ç‰ˆæœ¬çš„å…¼å®¹æ€§

---

**ğŸ“… åˆ›å»ºæ—¶é—´**: 2025-09-18
**ğŸ”’ æ–‡æ¡£çŠ¶æ€**: é”å®š - ä¸¥ç¦æœªç»æˆæƒçš„ä¿®æ”¹
**âœ… æ‰¹å‡†çŠ¶æ€**: å¾…é¡¹ç›®è´Ÿè´£äººç¡®è®¤