# 01-固定接口规范

> **严禁当一个接口被占用就去用未经允许的其他接口**
>
> 本文档定义的所有接口**一旦确定不允许修改**，所有模块必须严格遵守

## 🌐 端口分配（严格固定）

| 服务 | 端口 | 协议 | 用途 | 状态 |
|------|------|------|------|------|
| Frontend (Main Page) | 3000 | HTTP | Google-like主页面 | 必须 |
| Open WebUI | 3001 | HTTP | AI聊天界面 | 必须 |
| Backend (Http API) | 8000 | HTTP | 核心业务API | 必须 |
| RAG Service | 8001 | HTTP | 向量检索服务 | 必须 |
| Push Service | 8002 | HTTP/WS | 推送服务 | 必须 |
| ChromaDB | 8003 | HTTP | 向量数据库 | 必须 |
| MCPO代理 | 8005 | HTTP | MCP到OpenAPI代理 | 必须 |
| Prism2 MCP Server | 8006 | HTTP | 股票分析MCP服务 | 必须 |
| Enhanced Dashboard API | 8081 | HTTP | 增强数据仪表板 | 必须 |
| Redis | 6379 | TCP | 缓存服务 | 共享 |
| PostgreSQL | 5432 | TCP | 数据库服务 | 共享 |
| Nginx | 9080 | HTTP | 反向代理 | 必须 |
| 大语言模型 | 11434 | HTTP | Ollama/Qwen/Deepseek | 必须 |

## 📡 模块间API接口（固定不变）

### 1. Frontend → Backend API
```
基础路径: http://backend:8000/api/v1/

GET  /stocks/search          # 股票搜索
GET  /stocks/{code}/info     # 基础信息
GET  /stocks/{code}/realtime # 实时价格
POST /stocks/dashboard       # Dashboard综合数据
WS   /ws/stocks/realtime     # 实时数据推送
```

### 2. Backend → RAG Service API
```
基础路径: http://rag-service:8001/api/v1/

POST /search                 # 向量搜索
POST /vectorize              # 文档向量化
GET  /health                 # 健康检查
```

### 3. Backend → AI Service API
```
基础路径: http://ai-service:11434/api/

POST /generate              # AI分析生成
POST /embeddings            # 向量生成
GET  /models                # 模型列表
```

### 4. Push Service API
```
基础路径: http://push-service:8002/api/v1/

POST /subscribe             # 订阅推送
POST /unsubscribe           # 取消订阅
POST /broadcast             # 广播消息
WS   /push                  # WebSocket推送
```

### 5. MCP Service API (新增)
```
基础路径: http://mcpo-proxy:8005/api/

GET  /tools                 # MCP工具列表
POST /tools/{tool_name}     # 调用MCP工具
GET  /openapi.json          # OpenAPI规范文档
```

### 6. Enhanced Dashboard API (新增)
```
基础路径: http://enhanced-api:8081/api/v1/

POST /stocks/dashboard      # 综合股票数据获取
GET  /                      # 健康检查
```

## 🗄️ 数据库接口（共享PostgreSQL）

### 核心表结构（严格固定）
```sql
-- 股票基础信息
stocks (code, name, market, industry, ...)

-- K线数据
ohlcv_data (stock_code, period, timestamp, ohlcv, ...)

-- 财务数据
financial_reports (stock_code, period, revenue, profit, ...)

-- 公司公告
company_announcements (stock_code, title, type, date, ...)

-- 股票新闻
stock_news (stock_code, title, content, publish_time, ...)

-- 龙虎榜数据
longhubang_data (stock_code, trade_date, buy_amount, ...)

-- 股东变更
shareholder_changes (stock_code, shareholder, change_type, ...)

-- AI分析结果
ai_analysis_results (stock_code, analysis_type, scores, ...)
```

## 📦 Redis缓存接口（共享Redis）

### 缓存键规范（严格固定）
```python
# 股票数据缓存 (Database 0)
stock:info:{code}           # 基础信息 TTL:1天
stock:kline:{code}:{period} # K线数据 TTL:30分钟
stock:news:{code}           # 新闻数据 TTL:4小时
stock:analysis:{code}       # AI分析 TTL:1天

# 搜索缓存 (Database 1)
search:{query_hash}         # 搜索结果 TTL:5分钟

# 系统缓存 (Database 2)
rate:{ip}:{endpoint}        # 限流 TTL:1分钟
health:{service}            # 健康状态 TTL:30秒
```

## 📊 Dashboard数据组装详解

### Dashboard API: POST /stocks/dashboard

#### 请求格式
```json
{
  "stock_code": "000001",
  "data_types": ["basic_info", "realtime", "kline", "financial", "news", "announcements", "longhubang", "ai_analysis"]
}
```

#### 数据获取逻辑 (按三级优先级)
```
1. 基础信息 (basic_info)
   Redis: stock:info:000001 → PostgreSQL: stocks表 → AKShare: stock_info_a_code_name()

2. 实时价格 (realtime)
   直接AKShare: stock_zh_a_spot_em() [不缓存，实时获取]

3. K线数据 (kline)
   Redis: stock:kline:000001:1d → PostgreSQL: ohlcv_data表 → AKShare: stock_zh_a_hist()

4. 财务数据 (financial)
   Redis: stock:financial:000001 → PostgreSQL: financial_reports表 → AKShare: stock_financial_report()

5. 新闻数据 (news)
   Redis: stock:news:000001 → PostgreSQL: stock_news表 → RSS新闻源处理

6. 公司公告 (announcements)
   Redis: stock:announcements:000001 → PostgreSQL: company_announcements表 → AKShare: stock_announcement()

7. 龙虎榜数据 (longhubang)
   Redis: stock:longhubang:000001 → PostgreSQL: longhubang_data表 → AKShare: stock_lhb_detail()

8. AI分析 (ai_analysis)
   Redis: ai:analysis:000001 → PostgreSQL: ai_analysis_results表 → 调用AI Service生成
```

#### 响应格式
```json
{
  "success": true,
  "stock_code": "000001",
  "timestamp": "2025-09-18T15:30:00Z",
  "data": {
    "basic_info": {
      "code": "000001",
      "name": "平安银行",
      "market": "SZ",
      "industry": "银行",
      "market_cap": 280000000000
    },
    "realtime": {
      "current_price": 12.35,
      "change_percent": 2.15,
      "volume": 150000000,
      "timestamp": "2025-09-18T15:30:00Z"
    },
    "kline": {
      "period": "1d",
      "data": [
        {
          "timestamp": "2025-09-18",
          "open": 12.10,
          "high": 12.40,
          "low": 12.05,
          "close": 12.35,
          "volume": 150000000
        }
      ]
    },
    "financial": {
      "latest_quarter": "2024Q3",
      "revenue": 180000000000,
      "net_profit": 38000000000,
      "roe": 12.5
    },
    "news": [
      {
        "title": "平安银行发布三季报",
        "summary": "净利润同比增长8.2%",
        "publish_time": "2025-09-18T10:00:00Z",
        "sentiment_score": 0.75
      }
    ],
    "announcements": [
      {
        "title": "关于董事会决议的公告",
        "type": "重大事项",
        "publish_date": "2025-09-18"
      }
    ],
    "longhubang": {
      "trade_date": "2025-09-17",
      "rank_reason": "日跌幅偏离值达7%",
      "buy_amount": 500000000,
      "sell_amount": 300000000
    },
    "ai_analysis": {
      "analysis_type": "comprehensive",
      "six_dimension_scores": {
        "growth": 0.75,
        "profitability": 0.82,
        "risk": 0.65,
        "valuation": 0.70,
        "technical": 0.68,
        "market_sentiment": 0.72
      },
      "investment_recommendation": "买入",
      "confidence_level": 0.78,
      "summary": "基本面良好，技术面偏强，建议关注"
    }
  }
}
```

## 🔄 数据查询优先级（严格执行）

### 三级查询策略（不可更改）
```
1. Redis缓存查询 (优先级1, <1ms)
   ↓ 未命中
2. PostgreSQL查询 (优先级2, 10-50ms)
   ↓ 不存在/过期
3. AKShare API (优先级3, 200-2000ms)
   ↓ 更新缓存和数据库
```

### 实时数据特殊处理

#### Dashboard初始加载
```
POST /stocks/dashboard → 返回当前快照数据 (所有数据的当前值)
```

#### 实时数据推送 (WebSocket)
```
技术面实时数据 → WebSocket主动推送 → Dashboard页面实时更新

推送内容:
- 实时价格 (价格、涨跌幅、成交量)
- 实时指标 (换手率、振幅、委比等)
- 盘口数据 (买卖五档)
- 分时图数据 (每分钟更新)

推送频率: 交易时间内每30秒推送一次
```

### AI分析数据准备流程
```
AI分析请求 → 检查PostgreSQL数据完整性 → 数据不足时从AKShare补全 → 调用RAG Service获取上下文 → 调用AI Service生成分析 → 缓存结果
```

## 📡 WebSocket实时推送协议

### WebSocket连接: WS /ws/stocks/realtime

#### 客户端订阅消息
```json
{
  "type": "subscribe",
  "stock_codes": ["000001", "000002", "600519"],
  "data_types": ["price", "volume", "indicators", "orderbook"]
}
```

#### 服务端推送消息格式

##### 1. 实时价格推送
```json
{
  "type": "price_update",
  "stock_code": "000001",
  "timestamp": "2025-09-18T09:30:15Z",
  "data": {
    "current_price": 12.35,
    "change_amount": 0.15,
    "change_percent": 1.23,
    "volume": 1500000,
    "turnover": 18525000,
    "high": 12.40,
    "low": 12.20,
    "open": 12.25
  }
}
```

##### 2. 技术指标推送
```json
{
  "type": "indicators_update",
  "stock_code": "000001",
  "timestamp": "2025-09-18T09:30:15Z",
  "data": {
    "turnover_rate": 0.35,
    "amplitude": 1.65,
    "volume_ratio": 1.2,
    "pe_ratio": 8.5,
    "pb_ratio": 0.7,
    "moving_averages": {
      "ma5": 12.28,
      "ma10": 12.15,
      "ma20": 12.05
    }
  }
}
```

##### 3. 盘口数据推送 (买卖五档)
```json
{
  "type": "orderbook_update",
  "stock_code": "000001",
  "timestamp": "2025-09-18T09:30:15Z",
  "data": {
    "bid": [
      {"price": 12.34, "volume": 100},
      {"price": 12.33, "volume": 200},
      {"price": 12.32, "volume": 150},
      {"price": 12.31, "volume": 300},
      {"price": 12.30, "volume": 250}
    ],
    "ask": [
      {"price": 12.35, "volume": 80},
      {"price": 12.36, "volume": 120},
      {"price": 12.37, "volume": 90},
      {"price": 12.38, "volume": 200},
      {"price": 12.39, "volume": 180}
    ]
  }
}
```

##### 4. 分时图数据推送
```json
{
  "type": "minute_data",
  "stock_code": "000001",
  "timestamp": "2025-09-18T09:30:00Z",
  "data": {
    "time": "09:30",
    "price": 12.35,
    "volume": 150000,
    "avg_price": 12.32
  }
}
```

#### 客户端取消订阅
```json
{
  "type": "unsubscribe",
  "stock_codes": ["000002"]
}
```

#### 连接心跳
```json
{
  "type": "ping",
  "timestamp": "2025-09-18T09:30:15Z"
}
```

#### 服务端心跳响应
```json
{
  "type": "pong",
  "timestamp": "2025-09-18T09:30:15Z"
}
```

## 🚀 外部数据源接口

### AKShare API调用（主要数据源）
```python
# 实时数据
ak.stock_zh_a_spot_em()     # 实时价格
ak.stock_zh_a_hist()        # 历史K线

# 基础数据
ak.stock_info_a_code_name() # 股票列表
ak.stock_individual_info()  # 公司信息

# 财务数据
ak.stock_financial_report() # 财务报表
ak.stock_announcement()      # 公司公告
```

### RSS新闻源（辅助数据源）
```
新浪财经RSS: http://rss.sina.com.cn/roll/finance/hot_roll.xml
(其他RSS源已失效，仅保留此一个有效源)
```

## ⚠️ 接口使用原则

1. **严禁随意更改** - 接口一旦定义，任何模块不得私自修改
2. **版本控制** - API变更必须通过版本号区分 (/api/v1/, /api/v2/)
3. **统一错误码** - 所有API使用统一的HTTP状态码和错误格式
4. **接口文档先行** - 新接口必须先更新此文档，获得批准后才能实现
5. **向后兼容** - 新版本API必须保持对旧版本的兼容性

---

**📅 创建时间**: 2025-09-18
**🔒 文档状态**: 锁定 - 严禁未经授权的修改
**✅ 批准状态**: 待项目负责人确认